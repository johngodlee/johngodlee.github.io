<!DOCTYPE html>
<html lang="en-gb">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>John L. Godlee</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">John L. Godlee</a></li>
      
      <li><a href="/cv">CV</a></li>
      
      <li><a href="/works">Works</a></li>
      
    </ul>
    <hr/>
    </nav>


<div>
<h1>Compiling a single master.tex from a modular document</h1>

<h2>2020-04-25</h2>
</div>

<main>
<p>I&rsquo;ve recently submitted a paper to a peer reviewed journal. During the final proofing process it was clear that the editors at the journal had taken my original paper.tex file, which calls a load of other .tex files using <code>\input{}</code>, as well as a .bib file with <code>\bibliography{}</code>, and subbed in the contents of those files to form one .tex file which could then be compiled on its own, without the additional files originally called by my paper.tex.</p>
<p>It seemed like this process could be automated somewhat, so I set about writing a bash script.</p>
<pre tabindex="0"><code class="language-shell-script" data-lang="shell-script">#!/usr/bin/env bash

# Run latexmk
latexmk $1

# Get filename without extension
base=&quot;${1%.*}&quot;

# Create main.tex
cp &quot;${base}.tex&quot; &quot;main.tex&quot;

# Create \input{} filepaths array
inputs=($(grep -E '\\input{.*}' $1 | sed 's/.*{\([^]]*\)}.*/\1/g'))

# Create \input{} line number array
inputlines=($(grep -n '\\input{.*}' $1 | cut -f1 -d: ))

# Loop over each element of both array to create a sed statement
# which replaces the \input{} lines with the contents of the referenced file
for ((i=0;i&lt;${#inputlines[@]};++i)); do
   printf -v s '%s%s\n%s\n' &quot;$s&quot; &quot;${inputlines[i]}r ${inputs[i]}&quot; &quot;${inputlines[i]}d&quot;
done

# Run sed 
sed -i.bak -e &quot;$s&quot; main.tex

# Find bibliography line number
bibline=&quot;$(grep -n '\\bibliography{.*}' main.tex | cut -f1 -d: )&quot;

# Replace \bibliography{} with formatted contents of
# .bbl file generated by latexmk
sed -i.bak -e &quot;${bibline}r ${base}.bbl&quot; -e &quot;${bibline}d&quot;  main.tex

# Clean up intermediate files
rm main.tex.bak
latexmk -C
</code></pre><p>First the script runs <code>latexmk</code> to compile the intermediate files and a .pdf. Then the script creates two array variables, one containing the filepaths of every file that is called by <code>\input{}</code> and the other containing the line numbers in paper.tex of each of those <code>\input{}</code> lines. Then the script runs a for loop which creates a big long multi-part <code>sed</code> statement, which replaces the lines with <code>input{}</code> with the contents of that file. As a side note, this is the first time I&rsquo;ve really used the sed <code>r</code> operator, and it looks super useful. Finally the script does similar but without a for loop to replace the bibliography command with the contents of paper.bbl, which is a TeX formatted file containing the bibliography, generated by <code>latexmk</code> from the .bib file. After that there is just some clean up to remove intermediate files and you&rsquo;re left with main.tex, which can then be sent off to reviewers or used for final proofing before publication, without the hassle of handling multiple documents. While multiple documents is useful during document creation, I feel it&rsquo;s less useful when you are trying to typeset the final document.</p>
<p>I got a lot of help and inspiration from the following StackExchange posts:</p>
<ul>
<li><a href="https://tex.stackexchange.com/questions/514153/dealing-with-strict-rules-for-paper-submission-using-latex" target="_blank">bibtex - Dealing with strict rules for paper submission using LaTeX - TeX - LaTeX Stack Exchange</a>
</li>
<li><a href="https://tex.stackexchange.com/questions/25713/how-do-i-combine-several-tex-files-into-one" target="_blank">automation - How do I combine several tex files into one? - TeX - LaTeX Stack Exchange</a>
</li>
<li><a href="https://tex.stackexchange.com/questions/62232/generating-a-single-tex-file-by-merging-different-tex-files" target="_blank">input - Generating a single TeX file by merging different TeX files - TeX - LaTeX Stack Exchange</a>
</li>
</ul>
<p>And from this question which I asked myself to help figure out the for loop bit:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/60980245/insert-file-contents-at-line-number-from-bash-arrays/60989942?noredirect=1#comment107902183_60989942" target="_blank">Insert file contents at line number from bash arrays - Stack Overflow</a>
</li>
</ul>

</main>

  <footer>
  <hr/>
  John L. Godlee | 
  <a href="mailto:johngodlee@gmail.com">johngodlee@gmail.com</a> |
  <a href="http://johngodlee.xyz//index.xml">RSS</a>

  </footer>
  </body>
</html>

