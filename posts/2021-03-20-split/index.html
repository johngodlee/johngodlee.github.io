<!DOCTYPE html>
<html lang="en-gb">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>John L. Godlee</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">John L. Godlee</a></li>
      
      <li><a href="/cv">CV</a></li>
      
      <li><a href="/works">Works</a></li>
      
    </ul>
    <hr/>
    </nav>


<div>
<h1>Splitting a large woodland survey plot into 1 ha subdivisions</h1>

<h2>2021-03-20</h2>
</div>

<main>
<p>In <a href="https://seosaw.github.io" target="_blank">SEOSAW</a>
 we have a few very large woodland monitoring plots. Six 25 ha plots in Republic of Congo, a 10 ha plot in the Democratic Republic of Congo, and a 4 ha plot in South Africa. SEOSAW advocates for using 1 ha square plots (100x100 m) in most cases, as do many other similar ecological plot networks, because they are big enough to be linked to remote sensing data, and big enough to include what is normally a representative sample of the woodland.</p>
<p>To increase the usefulness of the very large plots, we wanted to split them up into 1 ha square subdivisions, and attribute stems to each of these subdivisions based on stem location.</p>
<p>While the plots in the Congo already had stem locations on a grid within the plot, the South African plot only had latitude and longitude coordinates for each stem. Putting aside the possible inaccuracies caused by using a handheld GPS, the first problem to solve was converting those latitude and longitude coordinates to XY grid locations. Here is the function I wrote in R:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#8f5902;font-style:italic">#&#39; Convert lat-long stem coordinates to XY grid coordinates </span>
<span style="color:#8f5902;font-style:italic">#&#39;</span>
<span style="color:#8f5902;font-style:italic">#&#39; In rectangular plots to convert latitude and longitude coordinates to XY </span>
<span style="color:#8f5902;font-style:italic">#&#39; grid coordinates, using the southwest corner of the plot as the origin point </span>
<span style="color:#8f5902;font-style:italic">#&#39; (0,0), with the X axis increasing west -&gt; east.</span>
<span style="color:#8f5902;font-style:italic">#&#39;</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param x dataframe of stem data</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param polys sf object containing plot polygons, assumes all are rectangular</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param stem_plot_id column name string of plot IDs in x</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param polys_plot_id column name string of plot IDs in polys</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param longitude column name string of stem longitude in x</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param latitude column name string of stem latitude in x</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param x_crs coordinate reference system (CRS) or EPSG code of stem </span>
<span style="color:#8f5902;font-style:italic">#&#39;     coordinates. </span>
<span style="color:#8f5902;font-style:italic">#&#39;</span>
<span style="color:#8f5902;font-style:italic">#&#39; @return dataframe of measurement IDs with x_grid and y_grid filled </span>
<span style="color:#8f5902;font-style:italic">#&#39;     with estimated XY grid coordinates. NA values returned if </span>
<span style="color:#8f5902;font-style:italic">#&#39;     longitude and latitude were missing. </span>
<span style="color:#8f5902;font-style:italic">#&#39; </span>
<span style="color:#8f5902;font-style:italic">#&#39; @examples</span>
<span style="color:#8f5902;font-style:italic">#&#39; </span>
<span style="color:#8f5902;font-style:italic">#&#39; </span>
<span style="color:#8f5902;font-style:italic">#&#39; @export</span>
<span style="color:#8f5902;font-style:italic">#&#39; </span>
<span style="color:#000">gridCoordGen</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">polys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stem_plot_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;plot_id&#34;</span><span style="color:#000;font-weight:bold">,</span> 
  <span style="color:#000">polys_plot_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">stem_plot_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">measurement_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;measurement_id&#34;</span><span style="color:#000;font-weight:bold">,</span>  
  <span style="color:#000">longitude</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;longitude&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">latitude</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;latitude&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">x_crs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4326</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>

  <span style="color:#8f5902;font-style:italic"># Split stems by plot_id</span>
  <span style="color:#000">x_split</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x[[stem_plot_id]]</span><span style="color:#000;font-weight:bold">)</span>

  <span style="color:#8f5902;font-style:italic"># For each plot</span>
  <span style="color:#000">grid_all</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">do.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">seq_along</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic"># Get plot ID</span>
    <span style="color:#000">plot_id</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">unique</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split[[y]][[stem_plot_id]]</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Subset polys to plot ID</span>
    <span style="color:#000">poly_fil</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">polys[polys[[polys_plot_id]]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">plot_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span>

    <span style="color:#8f5902;font-style:italic"># Convert corners to points</span>
    <span style="color:#000">poly_points</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_coordinates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poly_fil</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Get UTM zone of corners</span>
    <span style="color:#000">utm_string</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">UTMProj4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">latLong2UTM</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poly_points[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poly_points[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)))</span>

    <span style="color:#8f5902;font-style:italic"># Convert polygons to UTM</span>
    <span style="color:#000">poly_utm</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_transform</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poly_fil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">utm_string</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Convert UTM polygons to points</span>
    <span style="color:#000">points_utm</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_cast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poly_utm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;POINT&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">warn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span>

    <span style="color:#8f5902;font-style:italic"># Extract coordinates as dataframe</span>
    <span style="color:#000">coords_utm</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_coordinates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Define points to match corners to</span>
    <span style="color:#000">match_point</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_sfc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_point</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords_utm</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">X</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords_utm</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">Y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)))</span>
    <span style="color:#000">other_point</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_sfc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_point</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords_utm</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">X</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords_utm</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">Y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)))</span>

    <span style="color:#8f5902;font-style:italic"># Set CRS</span>
    <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">other_point</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">utm_string</span>
    <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">match_point</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">utm_string</span>

    <span style="color:#8f5902;font-style:italic"># Get sw and se corner</span>
    <span style="color:#000">sw_corner</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">points_utm[sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_nearest_feature</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">match_point</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">),</span><span style="color:#000">]</span>
    <span style="color:#000">se_corner</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">points_utm[sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_nearest_feature</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">other_point</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">),</span><span style="color:#000">]</span>

    <span style="color:#8f5902;font-style:italic"># Convert to WGS for geosphere compatibility</span>
    <span style="color:#000">sw_wgs</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_coordinates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_transform</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sw_corner</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4326</span><span style="color:#000;font-weight:bold">))</span>
    <span style="color:#000">se_wgs</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_coordinates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_transform</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">se_corner</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4326</span><span style="color:#000;font-weight:bold">))</span>

    <span style="color:#8f5902;font-style:italic"># Find rotation along SW,SE edge</span>
    <span style="color:#000">xy_bearing</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">geosphere</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">bearing</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sw_wgs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">se_wgs</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Get centroid of polygon</span>
    <span style="color:#000">cent</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_centroid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_geometry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poly_utm</span><span style="color:#000;font-weight:bold">))</span>

    <span style="color:#8f5902;font-style:italic"># Get location of sw corner</span>
    <span style="color:#000">sw_cent</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_geometry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sw_corner</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Convert angle to radians for rotation</span>
    <span style="color:#000">angle</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">NISTunits</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">NISTdegTOradian</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">90</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">xy_bearing</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Convert stem coords to sf object</span>
    <span style="color:#000">x_sf</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">st_as_sf</span><span style="color:#000;font-weight:bold">(</span>
      <span style="color:#000">x_split[[y]][</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">measurement_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">longitude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">latitude</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span> 
      <span style="color:#000">coords</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">longitude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">latitude</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">na.fail</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_sf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x_crs</span>

    <span style="color:#8f5902;font-style:italic"># Transform stems sf to UTM</span>
    <span style="color:#000">x_utm</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">st_transform</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_sf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">utm_string</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Rotate the stems same as polygon</span>
    <span style="color:#000">x_rot</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_geometry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_utm</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">cent</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">rot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">angle</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">cent</span>
    <span style="color:#000">sw_cent_rot</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sw_cent</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">cent</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">rot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">angle</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">cent</span>
    <span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sw_cent_rot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_rot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#000">x_cent</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x_rot</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">sw_cent_rot</span>
    
    <span style="color:#000">x_cent_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">st_coordinates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_cent</span><span style="color:#000;font-weight:bold">))</span>
    <span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_cent_df</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;x_grid&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;y_grid&#34;</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Add cordinates to dataframe</span>
    <span style="color:#000">x_out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">st_drop_geometry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_sf</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">x_cent_df</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Sub in empty stems</span>
    <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">any</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">x_split[[y]][[measurement_id]]</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">x_out[[measurement_id]]</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">missed_stems</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x_split[[y]][</span>
        <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">x_split[[y]][[measurement_id]]</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">x_out[[measurement_id]]</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">measurement_id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span>

      <span style="color:#000">x_out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">missed_stems</span><span style="color:#000;font-weight:bold">)</span>

      <span style="color:#8f5902;font-style:italic"># NaN to NA</span>
      <span style="color:#000">x_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x_grid</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">fillNA</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x_grid</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000">x_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">y_grid</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">fillNA</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">y_grid</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic"># Return</span>
    <span style="color:#000">x_out</span>
  <span style="color:#000;font-weight:bold">}))</span>

  <span style="color:#8f5902;font-style:italic"># Return</span>
  <span style="color:#000">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">grid_all</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Hopefully the comments on the code suffice to describe whats going on, but the basic idea is that the function takes a dataframe of stem measurements in multiple plots and an <code>{sf}</code> polygons object with multiple plot polygons, linked by the <code>plot_id</code> column. For each plot, the function follows this process:</p>
<ol>
<li>Find the southwest and southeast corners of the polygon</li>
<li>Rotate both the polygon and the stem locations so that the SW-SE axis of the polygon runs exactly E-W.</li>
<li>Calculate the E-W and N-S distance from the southwest corner of the plot to each stem location, in metres.</li>
</ol>
<p>Now the plots can be split into 1 ha subdivisions. Here is the R function I wrote:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#8f5902;font-style:italic">#&#39; Split large plots into 1 hectare squares </span>
<span style="color:#8f5902;font-style:italic">#&#39;</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param x dataframe of stem measurements</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param plot_data dataframe of plot measurements</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param dims named character vector of length 2, specifying the relationship</span>
<span style="color:#8f5902;font-style:italic">#&#39;     between the xy stem grid coordinate system and the plot dimensions, i.e.</span>
<span style="color:#8f5902;font-style:italic">#&#39;     does the x axis run along the plot length, or the plot width measurement</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param xy_zero_corner either &#34;sw&#34;, &#34;nw&#34;, &#34;ne&#34;, &#34;se&#34;, specifying the corner </span>
<span style="color:#8f5902;font-style:italic">#&#39;     of the grid coordinate system origin (0,0)</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param x_direction either &#34;ew&#34; (east-west) or &#34;ns&#34; (north-south), specifying </span>
<span style="color:#8f5902;font-style:italic">#&#39;     the direction of the x axis on the grid coordinate system from the </span>
<span style="color:#8f5902;font-style:italic">#&#39;     origin corner</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param subplot_size the length and width of square subplots, e.g. for 1 ha,</span>
<span style="color:#8f5902;font-style:italic">#&#39;     100</span>
<span style="color:#8f5902;font-style:italic">#&#39;</span>
<span style="color:#8f5902;font-style:italic">#&#39; @return list: </span>
<span style="color:#8f5902;font-style:italic">#&#39;     1) updated dataframe of stem measurements with added \code{subdiv_id} to</span>
<span style="color:#8f5902;font-style:italic">#&#39;     show which subdivision each stem belongs to.</span>
<span style="color:#8f5902;font-style:italic">#&#39;     2) sf dataframe of approximated subplot polygons and their centres.</span>
<span style="color:#8f5902;font-style:italic">#&#39;     3) updated dataframe of plot measurements with added \code{subdiv} to </span>
<span style="color:#8f5902;font-style:italic">#&#39;     show whether a plot has been subdivided, and \code{subdiv_id} to </span>
<span style="color:#8f5902;font-style:italic">#&#39;     identify new rows which are subdivided plots</span>
<span style="color:#8f5902;font-style:italic">#&#39; </span>
<span style="color:#8f5902;font-style:italic">#&#39; @details This function will only split a plot if it is rectangular and the </span>
<span style="color:#8f5902;font-style:italic">#&#39;     area can be divided into 1 hectare squares without remainder.</span>
<span style="color:#8f5902;font-style:italic">#&#39; </span>
<span style="color:#8f5902;font-style:italic">#&#39; @examples</span>
<span style="color:#8f5902;font-style:italic">#&#39; </span>
<span style="color:#8f5902;font-style:italic">#&#39; </span>
<span style="color:#8f5902;font-style:italic">#&#39; @export</span>
<span style="color:#8f5902;font-style:italic">#&#39; </span>
<span style="color:#000">largePlotSplit</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plot_data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">polys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stem_plot_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;plot_id&#34;</span><span style="color:#000;font-weight:bold">,</span> 
  <span style="color:#000">plot_plot_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">stem_plot_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">polys_plot_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">stem_plot_id</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">dims</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;plot_length&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;x_grid&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;plot_width&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;y_grid&#34;</span><span style="color:#000;font-weight:bold">),</span>
  <span style="color:#000">xy_zero_corner</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;sw&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x_direction</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;ew&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subplot_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>

  <span style="color:#8f5902;font-style:italic"># Check parameter specified correctly</span>
  <span style="color:#000">stopifnot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">any</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dims</span><span style="color:#000;font-weight:bold">)))</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.null</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dims</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dims</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">stopifnot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xy_zero_corner</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sw&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;se&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;nw&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ne&#34;</span><span style="color:#000;font-weight:bold">))</span>
  <span style="color:#000">stopifnot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_direction</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ns&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ew&#34;</span><span style="color:#000;font-weight:bold">))</span>

  <span style="color:#8f5902;font-style:italic"># Subset plots which are the right dimensions to split and which contain xy grid coords</span>
  <span style="color:#000">plots_fil</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">plot_data[</span>
    <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plot_data[</span><span style="color:#000">[names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dims</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[1]]]</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span>
    <span style="color:#000">plot_data[</span><span style="color:#000">[names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dims</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[1]]]</span> <span style="color:#ce5c00;font-weight:bold">%%</span> <span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span>
    <span style="color:#000">plot_data[</span><span style="color:#000">[names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dims</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[1]]]</span> <span style="color:#ce5c00;font-weight:bold">%/%</span> <span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span>
    <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plot_data[</span><span style="color:#000">[names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dims</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[2]]]</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span>
    <span style="color:#000">plot_data[</span><span style="color:#000">[names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dims</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[2]]]</span> <span style="color:#ce5c00;font-weight:bold">%%</span> <span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span>
    <span style="color:#000">plot_data[</span><span style="color:#000">[names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dims</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[2]]]</span> <span style="color:#ce5c00;font-weight:bold">%/%</span> <span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> 
    <span style="color:#000">plot_data[[plot_plot_id]]</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> 
      <span style="color:#000">unique</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x[</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x[[dims[1]]]</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x[[dims[2]]]</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">stem_plot_id]</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span>

  <span style="color:#8f5902;font-style:italic"># Subset stems by plot IDs</span>
  <span style="color:#000">x_fil</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x[x[[stem_plot_id]]</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">plots_fil[[plot_plot_id]]</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span>

  <span style="color:#8f5902;font-style:italic"># Split stem measurements by plot</span>
  <span style="color:#000">x_split</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_fil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x_fil[[stem_plot_id]]</span><span style="color:#000;font-weight:bold">)</span>

  <span style="color:#8f5902;font-style:italic"># For each plot:</span>
  <span style="color:#000">plot_out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">seq_along</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic"># New object, easier to work with</span>
    <span style="color:#000">x_split_iso</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split[[y]]</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Get plot ID</span>
    <span style="color:#000">plot_id</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">unique</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_iso[[stem_plot_id]]</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Throw warning if any stems not matched</span>
    <span style="color:#000">no_coords</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">which</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_iso[[dims[1]]]</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_iso[[dims[2]]]</span><span style="color:#000;font-weight:bold">))</span>
    <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">no_coords</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">warning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plot_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;: discarded &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">no_coords</span><span style="color:#000;font-weight:bold">),</span> 
        <span style="color:#4e9a06">&#34; stems with no XY grid coordinates&#34;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000">x_split_fil</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x_split_iso[</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">no_coords</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span>

    <span style="color:#8f5902;font-style:italic"># Define bins per plot</span>
    <span style="color:#000">cut_length</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">plots_fil[plots_fil[[plot_plot_id]]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">plot_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dims</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[1]]</span> <span style="color:#ce5c00;font-weight:bold">%/%</span> <span style="color:#000">subplot_size</span>
    <span style="color:#000">cut_width</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">plots_fil[plots_fil[[plot_plot_id]]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">plot_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dims</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[2]]</span> <span style="color:#ce5c00;font-weight:bold">%/%</span> <span style="color:#000">subplot_size</span>

    <span style="color:#000">bin_length</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">seq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cut_length</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">subplot_size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">by</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">subplot_size</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">bin_width</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">seq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cut_width</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">subplot_size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">by</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">subplot_size</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Classify each grid point by bins</span>
    <span style="color:#000">x_split_fil</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">length_bin</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cut</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil[[dims[1]]]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bin_length</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">x_split_fil</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">width_bin</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cut</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil[[dims[2]]]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bin_width</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Get factor labels</span>
    <span style="color:#000">length_bin_labels</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">levels</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">length_bin</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">width_bin_labels</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">levels</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">length_bin</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Deal with values slightly outside bins</span>
    <span style="color:#8f5902;font-style:italic"># Length</span>
    <span style="color:#000">poss_fix_length</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x_split_fil</span><span style="color:#000">[is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">length_bin</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> 
      <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil[[dims[1]]]</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">dims[1]]</span>
    <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poss_fix_length</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">bin_length_close</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">closestMatch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bin_length</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">unlist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poss_fix_length</span><span style="color:#000;font-weight:bold">))</span>

      <span style="color:#000">bin_length_labs</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bin_length_close</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bin_length</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000">length_bin_labels[1]</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">else</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000">length_bin_labels</span><span style="color:#000">[which</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">bin_length</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">-1</span><span style="color:#000">]</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">})</span>

    <span style="color:#000">x_split_fil[</span>
      <span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">length_bin</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> 
      <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil[[dims[1]]]</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;length_bin&#34;</span><span style="color:#000">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">bin_length_labs</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic"># Width</span>
    <span style="color:#000">poss_fix_width</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x_split_fil</span><span style="color:#000">[is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">width_bin</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> 
      <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil[[dims[2]]]</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">dims[2]]</span>
    <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poss_fix_width</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">bin_width_close</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">closestMatch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bin_width</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">unlist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poss_fix_width</span><span style="color:#000;font-weight:bold">))</span>

      <span style="color:#000">bin_width_labs</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bin_width_close</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bin_width</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000">width_bin_labels[1]</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">else</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000">width_bin_labels</span><span style="color:#000">[which</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">bin_width</span><span style="color:#000;font-weight:bold">)</span><span style="color:#0000cf;font-weight:bold">-1</span><span style="color:#000">]</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">})</span>

      <span style="color:#000">x_split_fil[</span>
        <span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">width_bin</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> 
        <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil[[dims[2]]]</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;width_bin&#34;</span><span style="color:#000">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">bin_width_labs</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic"># For each unique combination of bins, make a subplot, with name</span>
    <span style="color:#000">y_split</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">length_bin</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x_split_fil</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">width_bin</span><span style="color:#000;font-weight:bold">))</span>

    <span style="color:#000">poss_subsets</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plot_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;_S&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">seq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y_split</span><span style="color:#000;font-weight:bold">)))</span>

    <span style="color:#000">x_split_fil</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">do.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">seq_along</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y_split</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nrow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y_split[[z]]</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">y_split[[z]]</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">subdiv_id</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">poss_subsets[z]</span>
        <span style="color:#000">y_split[[z]]</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}))</span>

    <span style="color:#8f5902;font-style:italic"># Filter polygons to current plot ID</span>
    <span style="color:#000">polys_fil</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">polys[polys[[polys_plot_id]]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">plot_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span>

    <span style="color:#8f5902;font-style:italic"># Extract corners as dataframe</span>
    <span style="color:#000">polys_points</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_coordinates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">polys_fil</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Get UTM zone of corners</span>
    <span style="color:#000">utm_string</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">UTMProj4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">latLong2UTM</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">polys_points[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">polys_points[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)))</span>

    <span style="color:#8f5902;font-style:italic"># Convert polygons to UTM</span>
    <span style="color:#000">polys_utm</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_transform</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">polys_fil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">utm_string</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Convert UTM polygons to points</span>
    <span style="color:#000">points_utm</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_cast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">polys_utm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;POINT&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">warn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span>

    <span style="color:#8f5902;font-style:italic"># Extract coordinates as dataframe</span>
    <span style="color:#000">coords_utm</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_coordinates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Get zero and bearing point</span>
    <span style="color:#000">nw_outer</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_sfc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_point</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords_utm</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">X</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords_utm</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">Y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)))</span>
    <span style="color:#000">ne_outer</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_sfc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_point</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords_utm</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">X</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords_utm</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">Y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)))</span>
    <span style="color:#000">sw_outer</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_sfc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_point</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords_utm</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">X</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords_utm</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">Y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)))</span>
    <span style="color:#000">se_outer</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_sfc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_point</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords_utm</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">X</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords_utm</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">Y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)))</span>

    <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xy_zero_corner</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;sw&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">match_point</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sw_outer</span>
      <span style="color:#000">other_point</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">nw_outer</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">else</span> <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xy_zero_corner</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;nw&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">match_point</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">nw_outer</span>
      <span style="color:#000">other_point</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sw_outer</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">else</span> <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xy_zero_corner</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;ne&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">match_point</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">ne_outer</span>
      <span style="color:#000">other_point</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">se_outer</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">else</span> <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xy_zero_corner</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;se&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">match_point</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">se_outer</span>
      <span style="color:#000">other_point</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">ne_outer</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic"># Set CRS</span>
    <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">other_point</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">match_point</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Get xy zero and opposite corner</span>
    <span style="color:#000">xy_zero</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">points_utm[sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_nearest_feature</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">match_point</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">),</span><span style="color:#000">]</span>
    <span style="color:#000">xy_1</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">points_utm[sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_nearest_feature</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">other_point</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">),</span><span style="color:#000">]</span>

    <span style="color:#8f5902;font-style:italic"># Convert to WGS for geosphere compatibility</span>
    <span style="color:#000">xy_zero_wgs</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_coordinates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_transform</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xy_zero</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4326</span><span style="color:#000;font-weight:bold">))</span>
    <span style="color:#000">xy_1_wgs</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_coordinates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_transform</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xy_1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4326</span><span style="color:#000;font-weight:bold">))</span>

    <span style="color:#8f5902;font-style:italic"># Get bearing between points</span>
    <span style="color:#000">xy_bearing</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">geosphere</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">bearing</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xy_zero_wgs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xy_1_wgs</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Make grid of 1 ha plots</span>
    <span style="color:#000">bbox_grid</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bin_length</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bin_length</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span> 
      <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bin_width</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bin_width</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span>
    <span style="color:#000">bbox_sf</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_polygon</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bbox_grid</span><span style="color:#000;font-weight:bold">))</span>
    <span style="color:#000">polys_grid</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_make_grid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bbox_sf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cellsize</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">subplot_size</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">polys_grid</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Rotate to angle and move to centre of original plot</span>
    <span style="color:#000">cent</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_centroid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_combine</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">))</span>
    <span style="color:#000">grid_cent</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_centroid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_combine</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">polys_grid</span><span style="color:#000;font-weight:bold">))</span>
    <span style="color:#000">angle</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">NISTunits</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">NISTdegTOradian</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xy_bearing</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">polys_rot</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">polys_grid</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">grid_cent</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">rot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">angle</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">cent</span>
    <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">polys_rot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cent</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Set order of subset IDs </span>
    <span style="color:#000">byrow</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">ifelse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_direction</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;ns&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xy_zero_corner</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;se&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;nw&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">ord</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cut_width</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">else</span> <span style="color:#000;font-weight:bold">{</span> 
      <span style="color:#000">ord</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">cut_width</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xy_zero_corner</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sw&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;nw&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">subdiv_ids</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">poss_subsets</span> 
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">else</span> <span style="color:#000;font-weight:bold">{</span> 
      <span style="color:#000">subdiv_ids</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rev</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poss_subsets</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic"># Create matrix of subset IDs</span>
    <span style="color:#000">subset_mat</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">matrix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">subdiv_ids</span><span style="color:#000;font-weight:bold">,</span> 
      <span style="color:#000">nrow</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cut_width</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ncol</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cut_length</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">byrow</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">byrow</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[ord</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span>

    <span style="color:#8f5902;font-style:italic"># Apply matrix to name polygons</span>
    <span style="color:#000">polys_rot_sf</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_sf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">geometry</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">polys_rot</span><span style="color:#000;font-weight:bold">,</span> 
      <span style="color:#000">plot_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">plot_id</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">subdiv_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">as.vector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">subset_mat</span><span style="color:#000;font-weight:bold">)))</span>

    <span style="color:#000">polys_rot_wgs</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_transform</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">polys_rot_sf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4326</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">polys_rot_wgs</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[1]</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">plot_plot_id</span>

    <span style="color:#8f5902;font-style:italic"># Remove bins</span>
    <span style="color:#000">x_split_fil_clean</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x_split_fil[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> 
      <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;length_bin&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;width_bin&#34;</span><span style="color:#000;font-weight:bold">))</span><span style="color:#000">]</span>

    <span style="color:#8f5902;font-style:italic"># Add back in stems which had no grid coords</span>
    <span style="color:#000">x_split_iso</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">subdiv_id</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">NA_character_</span>

    <span style="color:#000">x_split_out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil_clean</span><span style="color:#000;font-weight:bold">,</span> 
      <span style="color:#000">x_split_iso[no_coords</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_fil_clean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span>


    <span style="color:#8f5902;font-style:italic"># Return list</span>
    <span style="color:#000">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split_out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">polys_rot_wgs</span><span style="color:#000;font-weight:bold">))</span>
  <span style="color:#000;font-weight:bold">})</span>

  <span style="color:#8f5902;font-style:italic"># Bind all stems together</span>
  <span style="color:#000">stems_out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">do.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plot_out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;[[&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>

  <span style="color:#8f5902;font-style:italic"># Bind back in stems from plots which weren&#39;t split</span>
  <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nrow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x[</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">x[[stem_plot_id]]</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">plots_fil[[plot_plot_id]]</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">stems_non</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x[</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">x[[stem_plot_id]]</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">plots_fil[[plot_plot_id]]</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span>
    <span style="color:#000">stems_non</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">subdiv_id</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">NA_character_</span>

    <span style="color:#000">stems_all</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stems_out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stems_non[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stems_out</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">stems_all</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">stems_out</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic"># Bind all polygons</span>
  <span style="color:#000">polys_out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">do.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plot_out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;[[&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>

  <span style="color:#8f5902;font-style:italic"># Add centres to polygons</span>
  <span style="color:#000">centres</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">suppressWarnings</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000">as.data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">st_coordinates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">st_centroid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">polys_out</span><span style="color:#000;font-weight:bold">))))</span>
  <span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">centres</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;longitude_of_centre&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;latitude_of_centre&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">polys_out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">polys_out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">centres</span><span style="color:#000;font-weight:bold">)</span>

  <span style="color:#8f5902;font-style:italic"># Add subdiv column to plots table</span>
  <span style="color:#000">plot_data</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">subdiv</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">ifelse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plot_data[[plot_plot_id]]</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> 
    <span style="color:#000">polys_out[[plot_plot_id]]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">)</span>

  <span style="color:#8f5902;font-style:italic"># Add subdivided columns to plots data</span>
  <span style="color:#000">subdiv_out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">merge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">st_drop_geometry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">polys_out</span><span style="color:#000;font-weight:bold">),</span> 
    <span style="color:#000">plot_data[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plot_data</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;longitude_of_centre&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;latitude_of_centre&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">by</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">plot_plot_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">all.x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">)</span>

  <span style="color:#000">subdiv_out[subdiv_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">subdiv_id</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">polys_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">subdiv_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;plot_area&#34;</span><span style="color:#000">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">subplot_size</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">subplot_size</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">10000</span>
  <span style="color:#000">subdiv_out[subdiv_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">subdiv_id</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">polys_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">subdiv_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;plot_length&#34;</span><span style="color:#000">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">subplot_size</span>
  <span style="color:#000">subdiv_out[subdiv_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">subdiv_id</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">polys_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">subdiv_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;plot_width&#34;</span><span style="color:#000">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">subplot_size</span>
  <span style="color:#000">subdiv_out[subdiv_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">subdiv_id</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">polys_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">subdiv_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;plot_perimeter&#34;</span><span style="color:#000">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">subplot_size</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">4</span>
  <span style="color:#000">subdiv_out[subdiv_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">subdiv_id</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">polys_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">subdiv_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;subdiv&#34;</span><span style="color:#000">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">FALSE</span> 
  <span style="color:#000">plot_data</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">subdiv_id</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">NA_character_</span>

  <span style="color:#000">plot_data_out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plot_data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subdiv_out[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plot_data</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span>

  <span style="color:#8f5902;font-style:italic"># Return list of output</span>
  <span style="color:#000">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stems_all</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">polys_out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plot_data_out</span><span style="color:#000;font-weight:bold">))</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Again, hopefully the comments explain everything, but this function is a bit more complicated, and I&rsquo;m more proud of it, so I&rsquo;ll describe it step by step.</p>
<ol>
<li>Find which plots are suitable for splitting. Plots must be rectangular, larger than 2 ha, the plot length and width must be divisible without remainder into 100 m lengths, and there must be at least one stem in the plot with grid coordinates.  Then, for each suitable plot:</li>
<li>Assign each stem to 100 m bins in the X and Y direction, using <code>cut()</code>.</li>
<li>For stems with grid coordinates slightly outside the plot boundary (this is often a problem when converting from lat-long to grid coordinates), find the closest bin, using a separate function called <code>closestMatch()</code>, see below for more details.</li>
<li>For each unique combination of bins, make a subdivision ID, and assign names based on the direction of stem coordinate progression and which corner the stem coordinate system originates from, referencing the <code>x_direction</code> and <code>xy_zero_corner</code> function parameters.</li>
<li>Make a grid of 1 ha square polygons from the plot dimensions, using <code>sf::st_make_grid()</code>. Then rotate the polygon grid and move to the centre of the existing plot polygon.</li>
<li>Name each of the subdivision polygons with the <code>subdiv_id</code> used for the stems.</li>
<li>Return a dataframe of stem measurements with <code>subdiv_id</code> values for each stem, and an <code>{sf}</code> object with the subdivision polygons and their centres.</li>
</ol>
<p>The plot below illustrates a 4 ha plot that has been split into four 1 ha subdivisions using the above methods.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ggplot2</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ggnewscale</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">viridis</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#000">ggplot</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
  <span style="color:#000">geom_sf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">polys_sf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">colour</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;black&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fill</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">NA</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
  <span style="color:#000">geom_sf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">out[[2]]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">aes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">colour</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">subdiv_id</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1.5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fill</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">NA</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
  <span style="color:#000">new_scale_colour</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
  <span style="color:#000">geom_point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">out[[1]]</span><span style="color:#000;font-weight:bold">,</span> 
    <span style="color:#000">aes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">longitude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">latitude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">colour</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x_grid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">shape</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">subdiv_id</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
  <span style="color:#000">scale_colour_viridis</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
  <span style="color:#000">theme_bw</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
  <span style="color:#000">labs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">)</span>
</code></pre></div><figure><a href="/img_full/split/split.png"><img
          alt="4 ha plot split, with stem locations"
          title="4 ha plot split, with stem locations"src="/img/split/split.png" 
      /></a></figure>


<p>Finally, here is the <code>closestMatch()</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#8f5902;font-style:italic">#&#39; Find closest match in a vector</span>
<span style="color:#8f5902;font-style:italic">#&#39;</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param x numeric vector </span>
<span style="color:#8f5902;font-style:italic">#&#39; @param y vector of numeric values, each of which be matched with the closest</span>
<span style="color:#8f5902;font-style:italic">#&#39;     value in \code{x}</span>
<span style="color:#8f5902;font-style:italic">#&#39;</span>
<span style="color:#8f5902;font-style:italic">#&#39; @return numeric vector of values of \code{x} that are closest to each </span>
<span style="color:#8f5902;font-style:italic">#&#39;     element of \code{y}</span>
<span style="color:#8f5902;font-style:italic">#&#39; </span>
<span style="color:#8f5902;font-style:italic">#&#39; @keywords internal</span>
<span style="color:#8f5902;font-style:italic">#&#39; @noRd</span>
<span style="color:#8f5902;font-style:italic">#&#39; </span>
<span style="color:#000">closestMatch</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">unlist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">x</span><span style="color:#000">[which</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">abs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">abs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)))</span><span style="color:#000">]</span>
  <span style="color:#000;font-weight:bold">}))</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div>
</main>

  <footer>
  <hr/>
  John L. Godlee | 
  <a href="mailto:johngodlee@gmail.com">johngodlee@gmail.com</a> |
  <a href="http://johngodlee.xyz//index.xml">RSS</a>

  </footer>
  </body>
</html>

