<!DOCTYPE html>
<html lang="en-gb">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>John L. Godlee</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">John L. Godlee</a></li>
      
      <li><a href="/cv">CV</a></li>
      
      <li><a href="/works">Works</a></li>
      
    </ul>
    <hr/>
    </nav>


<div>
<h1>Scraping museum catalogues</h1>

<h2>2021-07-05</h2>
</div>

<main>
<p>My partner is visiting some museums and art galleries in the eastern United States in the autumn, to look at Maya, Aztec and Mixtec artefacts that relate to slavery, captivity and forced labour. To find artefacts, she was looking through the online catalogues of each institution, and at the same time wanted to record metadata about the objects to refer back to later. Unfortunately, harvesting the metadata was taking a long time due to all the copying and pasting and manually saving images. I tried to help by writing a few scripts to scrape through the object records online and format the metadata in an organised format.</p>
<p>Some of the institutions provide decent APIs to get artefact data, but others only provide web pages, so I had to use a mixture of different methods to scrape the information.</p>
<p>The institutions I scraped were:</p>
<ul>
<li>Dumbarton Oaks</li>
<li>Museum of Fine Arts Boston</li>
<li>Nasher Museum of Art at Duke University</li>
<li>The Metropolitan Museum of Art New York</li>
<li>Yale Peabody Museum of Natural History</li>
<li>Penn Museum</li>
<li>Princeton University Art Museum</li>
<li>Smithsonian National Museum of Natural History</li>
</ul>
<p>For each of the institutions I was given a txt file of links. I used R to scrape the information as that&rsquo;s what I know best. For institutions who don&rsquo;t have APIs, i.e. Dumbarton Oaks, Museum of Fine Arts Boston, Nasher, Yale Peabody, and Penn Museum, I used <code>{rvest}</code> to parse the html files. For example, for Nasher:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#8f5902;font-style:italic"># Packages</span>
<span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvest</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dplyr</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># List record URLS</span>
<span style="color:#000">urls</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">readLines</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;links.txt&#34;</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># Download pages</span>
<span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">urls</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">download.file</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">destfile</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">file.path</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;html&#34;</span><span style="color:#000;font-weight:bold">,</span> 
      <span style="color:#000">gsub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/.*&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gsub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;https://emuseum.nasher.duke.edu/objects/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">))))</span>
<span style="color:#000;font-weight:bold">})</span>

<span style="color:#8f5902;font-style:italic"># List html files</span>
<span style="color:#000">html_files</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">list.files</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;html&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">full.names</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># For each file</span>
<span style="color:#000">out_list</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">html_files</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">read_html</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span>

  <span style="color:#8f5902;font-style:italic"># Get object title</span>
  <span style="color:#000">obj_title</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">html_nodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;div.titleField&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">html_nodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;h1&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">html_text</span><span style="color:#000;font-weight:bold">()</span>

  <span style="color:#8f5902;font-style:italic"># Get object metadata</span>
  <span style="color:#000">obj_labels</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">html_nodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;span.detailFieldLabel&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">html_text</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">gsub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:.*&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">.)</span>

  <span style="color:#000">obj_values</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">html_nodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;span.detailFieldValue&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">html_text</span><span style="color:#000;font-weight:bold">()</span>

  <span style="color:#8f5902;font-style:italic"># Create dataframe</span>
  <span style="color:#000">out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj_values</span><span style="color:#000;font-weight:bold">)))</span>
  <span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">out</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">obj_labels</span>

  <span style="color:#8f5902;font-style:italic"># Extract image IDs</span>
  <span style="color:#000">main_img_id</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">html_nodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;div.emuseum-img-wrap&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">html_nodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;img&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">html_attr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;src&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">gsub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/internal/media/dispatcher/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">.)</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">gsub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/.*&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">.)</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">unique</span><span style="color:#000;font-weight:bold">()</span>

  <span style="color:#000">sec_img_id</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span> 
    <span style="color:#000">html_nodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;div.secondarymedia-item&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">html_nodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">html_attr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;data-media-id&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
    <span style="color:#000">unique</span><span style="color:#000;font-weight:bold">()</span> 

  <span style="color:#000">img_id</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">unique</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">main_img_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sec_img_id</span><span style="color:#000;font-weight:bold">))</span>

  <span style="color:#8f5902;font-style:italic"># Construct image URLs</span>
  <span style="color:#000">img_url</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#4e9a06">&#34;https://emuseum.nasher.duke.edu/internal/media/dispatcher/&#34;</span><span style="color:#000;font-weight:bold">,</span> 
    <span style="color:#000">img_id</span><span style="color:#000;font-weight:bold">,</span> 
    <span style="color:#4e9a06">&#34;/resize%3Aformat%3Dfull&#34;</span><span style="color:#000;font-weight:bold">)</span>

  <span style="color:#8f5902;font-style:italic"># Create filenames</span>
  <span style="color:#000">img_filenames</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">`Object number`</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;_&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">img_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.jpg&#34;</span><span style="color:#000;font-weight:bold">)</span>

  <span style="color:#8f5902;font-style:italic"># Download images</span>
  <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">img_url[</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">img_url</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">download.file</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">img_url</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">destfile</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">file.path</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;img&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">img_filenames</span><span style="color:#000;font-weight:bold">),</span> 
      <span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;libcurl&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">else</span> <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">img_url[</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">img_url</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> 
    <span style="color:#000">download.file</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">img_url</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">destfile</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">file.path</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;img&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">img_filenames</span><span style="color:#000;font-weight:bold">))</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">out</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">})</span>

<span style="color:#8f5902;font-style:italic"># Write metadata to csv</span>
<span style="color:#000">out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">do.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bind_rows</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out_list</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#000">write.csv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all.csv&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">row.names</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">)</span>
</code></pre></div><p>I think Princeton probably had the nicest and simplest API to use, while the Smithsonian had the most difficult API. However, the complexity of the Smithsonian API is probably because they have lots of institutions all running the same API, and a very diverse range of records.</p>
<p>To query the API I used <code>{httr}</code>, and to parse the JSON returned by the APIs I used <code>{jsonlite}</code>. Using the Princeton API as an example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httr</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">jsonlite</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dplyr</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#000">base</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#4e9a06">&#34;https://data.artmuseum.princeton.edu/objects/&#34;</span>

<span style="color:#8f5902;font-style:italic"># Import links</span>
<span style="color:#000">links</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">readLines</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;links.txt&#34;</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># Get IDs</span>
<span style="color:#000">ids</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">gsub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.*/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">links</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># For each ID, get record</span>
<span style="color:#000">out_list</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ids</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">message</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#8f5902;font-style:italic"># Get record</span>
  <span style="color:#000">resp</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">GET</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">base</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">))</span>

  <span style="color:#8f5902;font-style:italic"># Parse JSON</span>
  <span style="color:#000">resp_parsed</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">content</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">as</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;parsed&#34;</span><span style="color:#000;font-weight:bold">)</span>

  <span style="color:#8f5902;font-style:italic"># Save JSON </span>
  <span style="color:#000">write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">content</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">as</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;text&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">file.path</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;json&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.json&#34;</span><span style="color:#000;font-weight:bold">)))</span>

  <span style="color:#000">ifnull</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> 
    <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">is.null</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span> 
      <span style="color:#000">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NA&#34;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span> 
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic"># Extract description</span>
  <span style="color:#000">desc_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">data.frame</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000">displayperiod</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">displayperiod</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">displayculture</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">displayculture</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">classification</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">classification</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">daterange</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">daterange</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">description</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">texts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">textentryhtml</span>
    <span style="color:#000;font-weight:bold">}),</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;; &#34;</span><span style="color:#000;font-weight:bold">)),</span>
    <span style="color:#000">accessionyear</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">accessionyear</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">titles[[1]]</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">catalograisonne</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">catalograisonne</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">objectnumber</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">objectnumber</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">objectid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">objectid</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">department</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">department</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">country</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">geography[[1]]</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">country</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">locale</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">geography[[1]]</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">locale</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">region</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">geography[[1]]</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">region</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">subcontinent</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">geography[[1]]</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">subcontinent</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">locus</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">geography[[1]]</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">locus</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">county</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">geography[[1]]</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">county</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">excavation</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">geography[[1]]</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">excavation</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">state</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">geography[[1]]</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">state</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">latitude</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">geography[[1]]</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">location</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">lat</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">longitude</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">geography[[1]]</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">location</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">lon</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">river</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">geography[[1]]</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">location</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">river</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">continent</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">geography[[1]]</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">continent</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">medium</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">medium</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">dimensions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ifnull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">dimensionelements</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">dimension</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">element</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">units</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sep</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:&#34;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">}),</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;; &#34;</span><span style="color:#000;font-weight:bold">))</span>
    <span style="color:#000;font-weight:bold">)</span>

  <span style="color:#000">img_list</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp_parsed</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">media</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">uri</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">})</span>

  <span style="color:#000">img_filenames</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;_&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">img_list</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;[&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">),</span>  <span style="color:#4e9a06">&#34;.jpg&#34;</span><span style="color:#000;font-weight:bold">)</span>

  <span style="color:#000">img_urls</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">img_list</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;[&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;/full/full/0/default.jpg&#34;</span><span style="color:#000;font-weight:bold">)</span>
  
  <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">img_list[</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">img_list</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">try</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">download.file</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">img_urls</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">destfile</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">file.path</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;img&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">img_filenames</span><span style="color:#000;font-weight:bold">),</span> 
      <span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;libcurl&#34;</span><span style="color:#000;font-weight:bold">))</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">else</span> <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">img_list[</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">img_list</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> 
    <span style="color:#000">try</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">download.file</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">img_urls</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">destfile</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">file.path</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;img&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">img_filenames</span><span style="color:#000;font-weight:bold">)))</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">desc_df</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">})</span>

<span style="color:#8f5902;font-style:italic"># Write metadata to csv</span>
<span style="color:#000">out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">do.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bind_rows</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out_list</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#000">write.csv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all.csv&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">row.names</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">)</span>
</code></pre></div>
</main>

  <footer>
  <hr/>
  John L. Godlee | 
  <a href="mailto:johngodlee@gmail.com">johngodlee@gmail.com</a> |
  <a href="http://johngodlee.xyz//index.xml">RSS</a>

  </footer>
  </body>
</html>

