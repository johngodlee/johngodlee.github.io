<!DOCTYPE html>
<html lang="en-gb">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>John L. Godlee</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">John L. Godlee</a></li>
      
      <li><a href="/files/cv/john_l_godlee_cv.pdf">CV</a></li>
      
      <li><a href="/works">Works</a></li>
      
    </ul>
    <hr/>
    </nav>


<div>
<h1>Filling gaps in plot coverage across a landscape based on forest structure</h1>

<h2>2025-09-06</h2>
</div>

<main>
<p>In the <a href="https://geo-trees.org/" target="_blank">GEO-TREES</a>
 project we are developing sites across tropical forests to calibrate and validate biomass maps, using a combination of airborne LiDAR (ALS), terrestrial LiDAR (TLS), and tree inventory data from permanent sample plots. We use the airborne LiDAR to scale up biomass estimates from the permanent plots across the landscape, by fitting a site-specific model which predicts biomass from forest structure (canopy height, canopy density, etc). To fit a model with good predictive power we need to have plots which cover the diversity of forest structural types found across the site. Most of the GEO-TREES sites already have some plots, but it&rsquo;s important to assess whether those plots are representative of the structural diversity found across the plots.</p>
<p>I&rsquo;ve written some code which (1) does an assessment of the structural diversity of the site from ALS data, (2) determines the extent to which existing plots within the site represent the structural diversity of the site, and (3) recommends locations for new plots which fill gaps in the coverage of the structural diversity of the site.</p>
<p>First, load packages:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># How representative of forest structure are plots in a site?</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># John L. Godlee (johngodlee@gmail.com)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Last updated: 2025-09-04</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Purpose:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># To what extent are existing plots representative of the broader landscape forest structure? </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Identify optimal locations for new plots to fill gaps in multidimensional forest structure space.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Load required libraries</span>
</span></span><span style="display:flex;"><span><span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dplyr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tidyr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ggplot2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">patchwork</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">terra</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plotly</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic"># Interactive 3D plots</span>
</span></span><span style="display:flex;"><span><span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">FNN</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic"># Nearest neighbor analysis</span>
</span></span><span style="display:flex;"><span><span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">scico</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic"># Color palettes</span>
</span></span><span style="display:flex;"><span><span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lhs</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic"># Latin-hypercube sampling</span>
</span></span></code></pre></div><p>Then I define <code>extract_plot_metrics()</code> to extract structural metrics from the ALS for each of the existing plots:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Extract values from raster across polygons</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @param r raster</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @param p_sf sf object containing plot polygons </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @param plot_id column name of plot IDs in `p_sf` </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @return dataframe containing extracted metrics for each polygon</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#000">extract_plot_metrics</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p_sf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plot_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;plot_id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fun</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mean</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Extract metrics for each plot polygon</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">terra</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">extract</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p_sf</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">fun</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fun</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">na.rm</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ID</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Add plot IDs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p_sf[[plot_id]]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">out</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[1]</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">plot_id</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Add XY coordinates of centroids</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">coords</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">st_coordinates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">st_centroid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p_sf</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;x&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;y&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">coords</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Return</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">out</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Then I define <code>analyse_repres()</code> which runs a principal component analysis of the structural metrics across the site and places the existing plots in PCA-space.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Run a PCA on the landscape structural metrics, and place plots in that space</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Get nearest neighbour distance from each landscape pixel to plots</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Return dataframe with metrics of plot coverage</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @param r raster </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @param p dataframe containing structural metrics for each plot, as returned</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     by `extract_plot_metrics()`</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @param n_pca number of PCA axes used in analysis</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @return list containing: `r_df`: pixel values, `p_df`: plot values, `r_pca`:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     PCA object from pixel values, `p_pca` plot values in PCA space,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     `nn_dist_mean`, `nn_dist_max`, `nn_dist_q95`: mean, max and 95th</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     percentile structural distance of pixels to nearest plot across the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     landscape, `coverage_score`: `1 - (mean(nn) / max(nn)`</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#000">analyse_repres</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_pca</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Convert raster to data frame for landscape</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">r_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">na.rm</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Select only metric columns </span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">metric_cols</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r_df</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r_df</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;x&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;y&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Standardize metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">r_sc</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">scale</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r_df[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">metric_cols]</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">p_sc</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">scale</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">metric_cols]</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># PCA to reduce dimensionality</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">r_pca</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">prcomp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r_sc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">scale</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Project plots into PCA space</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">p_pca</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">predict</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r_pca</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p_sc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Calculate nearest neighbor distances</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># For each landscape pixel, find distance to nearest plot</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">nn</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">get.knnx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p_pca[</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">n_pca]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r_pca</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x[</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">n_pca]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn.dist[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Add distances back to landscape dataframe</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">r_df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn_dist</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">nn</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">r_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r_df</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r_pca</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">n_pca]</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Add PCA values </span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">p_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">p</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">p_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p_df</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p_pca[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">n_pca]</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Create representativeness metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">r_df</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">r_df</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">p_df</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">p_df</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">r_pca</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">r_pca</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">p_pca</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">p_pca</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nn_dist_mean</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nn</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nn_dist_max</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nn</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nn_dist_q95</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">quantile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0.95</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">coverage_score</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nn</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nn</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Return</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">out</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Then I define <code>identify_optimal_plots()</code> to identify potential locations for new plots which most optimally fill gaps in PCA-space. This function allows different gap-filling algorithms:</p>
<ul>
<li><code>maximin_select()</code> - iteratively proposes new plots in pixels with structural attributes furthest away from the existing (and previously proposed) plots.</li>
<li><code>minimax_select()</code> - minimizes the maximum distance of any pixel to its nearest plot in PCA space.</li>
<li><code>lhs_select()</code> - latin-hypercube sampling. Optimises for uniform coverage across PCA space.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Define function for latin-hypercube sampling </span>
</span></span><span style="display:flex;"><span><span style="color:#000">lhs_select</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r_df</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_plots</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">min_dist</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Scale PCs to [0,1] for uniform LHS sampling</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">pcs</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">r_df[</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">pcs_scaled</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">scale</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pcs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">center</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">apply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pcs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">min</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">scale</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">apply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pcs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">apply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pcs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">min</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Generate LHS design</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lhs_design</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">randomLHS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n_plots</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Prepare candidates</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cand</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">r_df</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cand</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">seq_len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nrow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cand</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">plots_sel</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">data.frame</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">seq_len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n_plots</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># LHS target point</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">target</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">lhs_design[i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Compute distance from all candidates to LHS target</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dists</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rowSums</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">pcs_scaled</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">matrix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">target</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nrow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cand</span><span style="color:#000;font-weight:bold">),</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">byrow</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">))</span><span style="color:#000">^2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Filter by spatial distance to already-selected plots</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">nrow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plots_sel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">dists_spat</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">get.knnx</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">plots_sel[</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;x&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;y&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cand[</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;x&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;y&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn.dist[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">valid_cand</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">which</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dists_spat</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">min_dist</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">valid_cand</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">seq_len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nrow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cand</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">valid_cand</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Select candidate closest to the LHS target</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">best_idx</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">valid_cand</span><span style="color:#000">[which.min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dists[valid_cand]</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">new_plot</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cand[best_idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">warning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Could not find valid location for plot&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">next</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Append proposed plot</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">plots_sel</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plots_sel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">new_plot</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Remove selected location from candidates</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cand</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cand[cand</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">new_plot</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pcs_scaled</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">pcs_scaled[</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">new_plot</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">,</span> <span style="color:#000">drop</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Return</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plots_sel</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Define function for maximin sampling </span>
</span></span><span style="display:flex;"><span><span style="color:#000">maximin_select</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r_df</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_plots</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">min_dist</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Maximin: maximize the minimum distance to existing plots</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cand</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">r_df</span><span style="color:#000">[order</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r_df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn_dist</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">decreasing</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">),</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cand</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">seq_len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nrow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cand</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Iteratively add plots </span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">plots_sel</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">data.frame</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">seq_len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n_plots</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">nrow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plots_sel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># First plot: choose furthest from existing plots</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">new_plot</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cand[1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Re-calculate minimum distance between new plots and pixels </span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">dist_sel</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">get.knnx</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">plots_sel[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">cand[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn.dist[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Combine with distance to existing plots</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">comb_score</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">pmin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cand</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn_dist</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dist_sel</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Calculate minimum spatial distance between new plots and pixels </span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">dists_spat</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">get.knnx</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">plots_sel[</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;x&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;y&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cand[</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;x&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;y&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn.dist[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Filter to plots a minimum spatial distance away from other proposed plots</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">valid_cand</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">which</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dists_spat</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">min_dist</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Select candidate with maximum combined score</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">valid_cand</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">best_idx</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">valid_cand</span><span style="color:#000">[which.max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">comb_score[valid_cand]</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">new_plot</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cand[best_idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">warning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Could not find valid location for plot&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">next</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Append proposed plot</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">plots_sel</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plots_sel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">new_plot</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Remove selected location from cand</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cand</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cand[cand</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">new_plot</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Return</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plots_sel</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Define function for minimax sampling </span>
</span></span><span style="display:flex;"><span><span style="color:#000">minimax_select</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r_df</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_plots</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">min_dist</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Minimax: minimize the maximum distance from any pixel to the nearest plot</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cand</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">r_df</span><span style="color:#000">[order</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r_df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn_dist</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">decreasing</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">),</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cand</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">seq_len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nrow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cand</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Iteratively add plots</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">plots_sel</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">data.frame</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">seq_len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n_plots</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">nrow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plots_sel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># First plot: choose furthest from existing plots</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">new_plot</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cand[1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Re-calculate minimum distance between new plots and pixels </span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">dist_sel</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">get.knnx</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">plots_sel[</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">cand[</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn.dist[</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Effective nearest distance for each candidate</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">comb_score</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">pmin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cand</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn_dist</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dist_sel</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Calculate max distance if each candidate were added</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Lower is better (minimax criterion)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">max_dists</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">seq_len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nrow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cand</span><span style="color:#000;font-weight:bold">)),</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">test_sel</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plots_sel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cand[j</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">test_dists</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">get.knnx</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">test_sel[</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">cand[</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn.dist[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">test_dists</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Enforce spatial separation</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">dists_spat</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">get.knnx</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">plots_sel[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;x&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;y&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cand[</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;x&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;y&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn.dist[</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">valid_cand</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">which</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dists_spat</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">min_dist</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Select candidate that minimizes the maximum distance</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">valid_cand</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">best_idx</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">valid_cand</span><span style="color:#000">[which.min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_dists[valid_cand]</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">new_plot</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cand[best_idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">warning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Could not find valid location for plot&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">next</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Append proposed plot</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">plots_sel</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plots_sel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">new_plot</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Remove selected location from cand</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cand</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cand[cand</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">new_plot</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Return</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plots_sel</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Iteratively add locations which most efficiently fill the structural space</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @param repr object returned by `analyse_repres()`</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @param n_plots maximum number of new plots to add</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @param n_pca number of PCA axes used in analysis</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @param min_dist minimum spatial distance between new plots</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @param method either &#34;maximin&#34;, &#34;minimax&#34; or &#34;lhs&#34; to choose a gap-filling</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     algorithm</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @param elbow logical, if TRUE then plots are iteratively added up to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     `n_plots` to determine the reduction in mean structural distance across</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     the landscape</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @details</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># `method`: &#34;maximin&#34; iteratively proposes new plots in pixels with structural</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     attributes furthest away from the existing (and previously proposed)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     plots. &#34;minimax&#34; aims to minimize the maximum distance of any pixel to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     its nearest plot in PCA space. &#34;lhs&#34; (latin-hypercube sampling) doesn’t</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     focus on distances between points directly, instead it optimises for</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     uniform coverage across PCA space.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @return dataframe containing locations and structural metrics for proposed</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     new plots, ordered by largest reduction in mean structural distance of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     pixels to nearest plots</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#000">identify_optimal_plots</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">repr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_plots</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_pca</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">min_dist</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;maximin&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">elbow</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Extract dataframes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">r_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">repr</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">r_df</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">p_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">repr</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">p_df</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;maximin&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">plots_sel</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">maximin_select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r_df</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_plots</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">min_dist</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;minimax&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">plots_sel</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">minimax_select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r_df</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_plots</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">min_dist</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;lhs&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">plots_sel</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">lhs_select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r_df</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_plots</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">min_dist</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">stop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#39;method&#39; must be one of &#39;maximin&#39;, &#39;minimax&#39; or &#39;lhs&#39;&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Remove ID value</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">plots_sel</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">plots_sel[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plots_sel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Optionally create elbow plot to find optimal number of new plots</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">elbow</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">elbow_dist</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Iteratively add new plots to plot data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">n_plots</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">pca_comb</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">p_df[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">plots_sel[1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Calculate mean distance between pixels and plots (old and new) </span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">nn</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">get.knnx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pca_comb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r_df[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">n_pca</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn.dist[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">elbow_dist[i</span><span style="color:#0000cf;font-weight:bold">+1</span><span style="color:#000">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nn</span><span style="color:#000;font-weight:bold">)</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Create pretty dataframe</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">elbow_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">data.frame</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">new_plots</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">n_plots</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">nn_dist_mean</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">elbow_dist</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Create bar plot</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">ggplot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">elbow_df</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">aes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">new_plots</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">nn_dist_mean</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">geom_col</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">theme_bw</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">scale_x_continuous</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">breaks</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">seq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_plots</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">labs</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Number of additional plots&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Mean relative distance in structural space to nearest plot&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">coord_cartesian</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ylim</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elbow_df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn_dist_mean</span><span style="color:#000;font-weight:bold">),</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elbow_df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn_dist_mean</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">elbow_df</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Return</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plots_sel</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>And finally I define <code>plot_repres()</code> to visualise the results of the analysis:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Visualise outputs of representivity analysis</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @param repr object returned by `analyse_repres()`</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @param plots_sel optional, object returned by `identify_optimal_plots()`</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># @return plots to visualise plots in structural space. `map` shows the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     location of plots and the structural distance of each pixel in the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     landscape to its nearest plot, if `plots_sel` is provided this includes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     the proposed new plots. `pca2d` scatter plot of the first two PCA axes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     of structural metrics. `pca3d` an interactive (plotly) 3D scatter plot of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     the first three PCA axes of structural metrics. `hist` (only returned if</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     `plots_sel` is provided) histograms showing the distance in structural</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     PCA space from each pixel to its nearest plot, comparing the distribution</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     when using only existing plots to the distribution when including the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     proposed new plots.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#000">plot_repres</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">repr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plots_sel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Extract dataframes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">r_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">repr</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">r_df</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">p_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">repr</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">p_df</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Map of representativeness (multi-dimensional distance to nearest plot)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">p_old</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">p_df[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;x&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;y&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#000">p_old</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">type</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#4e9a06">&#34;Existing plot&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.null</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plots_sel</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">p_new</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">plots_sel[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;x&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;y&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">p_new</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">type</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#4e9a06">&#34;Proposed plot&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">p_all</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p_old</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p_new</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">p_all</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">p_old</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Define legend items </span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">size_map</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Existing plot&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Proposed plot&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Landscape value&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">opacity_map</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Existing plot&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Proposed plot&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Landscape value&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.4</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">colour_map</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Existing plot&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;red&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Proposed plot&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;blue&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Landscape value&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;grey&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">shape_map</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Existing plot&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;circle&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Proposed plot&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;circle&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Landscape value&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;circle&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">p1</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">ggplot</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">geom_raster</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">r_df</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">aes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fill</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">nn_dist</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">scale_fill_scico</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Distance to nearest plot&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">palette</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;bamako&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">geom_point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">p_all</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">aes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">shape</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">colour</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">scale_colour_manual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">values</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">colour_map</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">scale_shape_manual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">values</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">shape_map</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">coord_equal</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">theme_bw</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ggtitle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Landscape representativeness&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">labs</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">theme</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">plot.title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">element_text</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">hjust</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.5</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">legend.position</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;bottom&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">legend.title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">element_text</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">legend.text</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">element_text</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Extract variance explained by each PCA axis</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">pca_var</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">summary</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">repr</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">r_pca</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">importance[2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000">]</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">pca_pt_r</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">repr</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">r_pca</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">pca_pt_r</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">type</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#4e9a06">&#34;Landscape value&#34;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#000">pca_pt_p</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">repr</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">p_pca[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">pca_pt_p</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">type</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#4e9a06">&#34;Existing plot&#34;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.null</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plots_sel</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pca_pt_n</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">plots_sel[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pca_pt_n</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">type</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#4e9a06">&#34;Proposed plot&#34;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">pca_pt_all</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pca_pt_r</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pca_pt_p</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pca_pt_n</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pca_pt_all</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pca_pt_r</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pca_pt_p</span><span style="color:#000;font-weight:bold">)</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">pca_pt_all</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">type</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">factor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pca_pt_all</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">levels</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Landscape value&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Existing plot&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Proposed plot&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#000">p2</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">ggplot</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">geom_point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pca_pt_all</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">aes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PC1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PC2</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">shape</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">colour</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">alpha</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">scale_size_manual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">values</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">size_map</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">scale_colour_manual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">values</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">colour_map</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">scale_shape_manual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">values</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">shape_map</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">scale_alpha_manual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">values</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">opacity_map</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">xlab</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC1 (&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pca_var[1]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;%)&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ylab</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC2 (&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pca_var[2]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;%)&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">theme_bw</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ggtitle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Structural space coverage&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">theme</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plot.title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">element_text</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">hjust</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.5</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># 3D PCA plot</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">p3</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">plot_ly</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;scatter3d&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;markers&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">layout</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Structural space coverage&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">scene</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">xaxis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC1 (&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pca_var[1]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;%)&#34;</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">yaxis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC2 (&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pca_var[2]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;%)&#34;</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">zaxis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC3 (&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pca_var[3]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;%)&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">unique</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pca_pt_all</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">subset_pca_pt_all</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">pca_pt_all[pca_pt_all</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">type</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#000">p3</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">add_trace</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">p3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">subset_pca_pt_all</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#000">PC1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#000">PC2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">z</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#000">PC3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">marker</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">size_map[t]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">opacity</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">opacity_map[t]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">colour_map[t]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">symbol</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">shape_map[t]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">line</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">width</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;black&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Coverage improvement analysis</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.null</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plots_sel</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Recalculate distances with new plots</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">all_plots_pca</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">repr</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">p_pca[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">as.matrix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plots_sel[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">nn_new</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">get.knnx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">all_plots_pca</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">repr</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">r_pca</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PC&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Create dataframe</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">improvement_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">data.frame</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">orig</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">repr</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">r_df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn_dist</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">with_new</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">nn_new</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">nn.dist[</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">pivot_longer</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">everything</span><span style="color:#000;font-weight:bold">(),</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">names_to</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;scenario&#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">values_to</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;distance&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">mutate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">scenario</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">factor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">scenario</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">levels</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;orig&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;with_new&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">labels</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Existing plots&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Existing and proposed plots&#34;</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">p4</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">ggplot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">improvement_df</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">aes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">distance</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fill</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">scenario</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">geom_histogram</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">alpha</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.7</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">position</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;identity&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bins</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">scale_fill_manual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">values</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Existing plots&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;red&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Existing and proposed plots&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;blue&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">theme_bw</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">ggtitle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Landscape coverage by plots&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">labs</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Relative distance in structural space to nearest plot&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Number of pixels&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">theme</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">plot.title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">element_text</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">hjust</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.5</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">legend.position</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;bottom&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">p1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pca2d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">p2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pca3d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">p3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hist</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">p4</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">p1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pca2d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">p2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pca3d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">p3</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Here is a worked example with the latin-hypercube sampling:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Import ALS metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#000">als</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;./als.tiff&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Import 50x50 m plot polygons</span>
</span></span><span style="display:flex;"><span><span style="color:#000">subplots</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">st_read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;./plots.gpkg&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Filter subplots to ALS data</span>
</span></span><span style="display:flex;"><span><span style="color:#000">als_poly</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">st_as_sf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">as.polygons</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">als</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">na.rm</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000">subplots_als</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">st_join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">subplots</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">als_poly</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">join</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">st_intersects</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#000">filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.na</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pulse_density</span><span style="color:#000;font-weight:bold">))</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Only include bottomleft subplots</span>
</span></span><span style="display:flex;"><span><span style="color:#000">subplots_fil</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">subplots_als</span> <span style="color:#ce5c00;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#000">filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">grepl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bottomleft&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subplot_id</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Select relevant metrics from ALS data</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># names(als)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">als_sel</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">als[</span><span style="color:#000">[c</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;zmax.canopy.vox&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;zmean.canopy.vox&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;zcv.canopy.vox&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;zskew.canopy.vox&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;zkurt.canopy.vox&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;zq10.canopy.vox&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;zq30.canopy.vox&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;zq50.canopy.vox&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;zq70.canopy.vox&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;zq90.canopy.vox&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;lad_cv.aboveground.vox&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;lad_sum.aboveground.vox&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Extract metrics from raster</span>
</span></span><span style="display:flex;"><span><span style="color:#000">p_ext</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">extract_plot_metrics</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">als_sel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subplots_fil</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#000">plot_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;subplot_id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fun</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mean</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Analyse representivity of plots</span>
</span></span><span style="display:flex;"><span><span style="color:#000">repr</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">analyse_repres</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">als_sel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p_ext</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_pca</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Explore the optimal number of new plots</span>
</span></span><span style="display:flex;"><span><span style="color:#000">identify_optimal_plots</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">repr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_plots</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;maximin&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">elbow</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Find optimal plots</span>
</span></span><span style="display:flex;"><span><span style="color:#000">optimal_plots_maximin</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">identify_optimal_plots</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">repr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n_plots</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;maximin&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Visualize</span>
</span></span><span style="display:flex;"><span><span style="color:#000">plots_vis</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">plot_repres</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">repr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">optimal_plots_maximin</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">plots_vis</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">map</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">plots_vis</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">pca2d</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">plots_vis</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">hist</span>
</span></span></code></pre></div><figure><a href="/img_full/plot_representivity/map.png"><img
          alt="Map showing structural diversity of the site with existing and suggested new plots."
          title="Map showing structural diversity of the site with existing and suggested new plots."src="/img/plot_representivity/map.png" 
      /></a></figure>


<figure><a href="/img_full/plot_representivity/pca2d.png"><img
          alt="PCA plot with existing plots, suggested new plots, and pixels across the landscape."
          title="PCA plot with existing plots, suggested new plots, and pixels across the landscape."src="/img/plot_representivity/pca2d.png" 
      /></a></figure>


<figure><a href="/img_full/plot_representivity/hist.png"><img
          alt="Histograms showing the structural distance of pixels to their most similar plot, using only existing plots (red) and also including new suggested plots (blue)"
          title="Histograms showing the structural distance of pixels to their most similar plot, using only existing plots (red) and also including new suggested plots (blue)"src="/img/plot_representivity/hist.png" 
      /></a></figure>



</main>

  <footer>
  <hr/>
  John L. Godlee | 
  <a href="mailto:johngodlee@gmail.com">johngodlee@gmail.com</a> |
  <a href="http://johngodlee.xyz//index.xml">RSS</a>

  </footer>
  </body>
</html>

