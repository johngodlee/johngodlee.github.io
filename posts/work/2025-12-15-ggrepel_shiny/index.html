<!DOCTYPE html>
<html lang="en-gb">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>John L. Godlee</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">John L. Godlee</a></li>
      
      <li><a href="/files/cv/john_l_godlee_cv.pdf">CV</a></li>
      
      <li><a href="/works">Works</a></li>
      
    </ul>
    <hr/>
    </nav>


<div>
<h1>Shiny app to interactively place ggrepel labels</h1>

<h2>2025-12-15</h2>
</div>

<main>
<p>I wrote an R Shiny app which allows you to interactively choose the location of labels placed using <code>ggrepel::geom_label_repel()</code> on a ggplot object.</p>
<p>The aim of the app is to streamline the process of deliberately placing labels when the automated label placement algorithm doesn&rsquo;t provide an acceptable solution.</p>
<p>Run the app by placing the code below in a file called <code>app.R</code>, then run from R using <code>shiny::runApp(&quot;./app.R&quot;)</code>.</p>
<figure><a href="/img_full/ggrepel_shiny/scrot.png"><img
          alt="Screenshot of the app running in a web browser."
          title="Screenshot of the app running in a web browser."src="/img/ggrepel_shiny/scrot.png" 
      /></a></figure>


<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Shiny app to interactively place ggrepel points</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># John L. Godlee (johngodlee@gmail.com)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Last updated: 2025-12-07</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Packages</span>
</span></span><span style="display:flex;"><span><span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">shiny</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ggplot2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ggrepel</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># UI</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ui</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">fluidPage</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">titlePanel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Interactive ggrepel Label Positioner&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#000">fluidRow</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">column</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">wellPanel</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">h4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Upload Data&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fileInput</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;csv_file&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Choose CSV File&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000">accept</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;text/csv&#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>                           <span style="color:#4e9a06">&#34;text/comma-separated-values,text/plain&#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>                           <span style="color:#4e9a06">&#34;.csv&#34;</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">p</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CSV must have columns: x, y, label&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">hr</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">h4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Instructions&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">p</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Click on a label to select it, then click where you want to move it.&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">hr</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">h4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Plot Limits&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">numericInput</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;x_min&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;X Min:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">step</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.5</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">numericInput</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;x_max&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;X Max:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">step</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.5</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">numericInput</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;y_min&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Y Min:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">step</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.5</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">numericInput</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;y_max&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Y Max:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">step</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.5</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">column</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">plotOutput</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ggplot&#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">width</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;700px&#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">height</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;500px&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">click</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;plot_click&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">hr</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">h3</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Generated R Code&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">verbatimTextOutput</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;r_code&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">p</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Copy and paste this code into your R script.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># SERVER</span>
</span></span><span style="display:flex;"><span><span style="color:#000">server</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">input</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">output</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Default data</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">default_data</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">data.frame</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4.5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">7.5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4.5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">7.5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">label</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Point A&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Point B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Point C&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Point D&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Point E&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">stringsAsFactors</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">FALSE</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Reactive data from file upload</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uploaded_data</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">reactive</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">req</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">csv_file</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">tryCatch</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">read.csv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">csv_file</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">datapath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stringsAsFactors</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Check for required columns</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;x&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;y&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;label&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">df</span><span style="color:#000;font-weight:bold">)))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">showNotification</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CSV must contain columns: x, y, label&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">default_data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Convert to proper types</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.numeric</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.numeric</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.character</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Remove rows with NA values</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">df</span><span style="color:#000">[complete.cases</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">df</span><span style="color:#000">[c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;x&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;y&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;label&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nrow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">df</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">showNotification</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;No valid data rows found&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">default_data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#000">showNotification</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Loaded&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nrow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">df</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;data points&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">df</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">error</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">showNotification</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error reading file:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">default_data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Use uploaded data if available, otherwise use default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">current_data</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">reactive</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.null</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">csv_file</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">uploaded_data</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">default_data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Reactive values</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">rv</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">reactiveValues</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">label_x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">label_y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">selected_label</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Initialize label positions when data changes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">observe</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">current_data</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">is.null</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label_x</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label_x</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">nrow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">df</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label_x</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label_y</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">y</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Auto-update axis limits when new data is loaded</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">observe</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">current_data</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.null</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">csv_file</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">x_range</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">na.rm</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">y_range</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">na.rm</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">x_padding</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">diff</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_range</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">0.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">y_padding</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">diff</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y_range</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">0.1</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#000">updateNumericInput</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;x_min&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">floor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_range[1]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">x_padding</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">updateNumericInput</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;x_max&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ceiling</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_range[2]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">x_padding</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">updateNumericInput</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;y_min&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">floor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y_range[1]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">y_padding</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">updateNumericInput</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;y_max&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ceiling</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y_range[2]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">y_padding</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Handle plot clicks</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">observeEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">plot_click</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">click</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">plot_click</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">is.null</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">selected_label</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Select the nearest label</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">distances</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sqrt</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label_x</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">click</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">^2</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label_y</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">click</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">^2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">distances</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">1.5</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">selected_label</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">which.min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">distances</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Move the selected label to click position</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label_x[rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">selected_label]</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">click</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label_y[rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">selected_label]</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">click</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">y</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">selected_label</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Render the ggplot</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">output</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">ggplot</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">renderPlot</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">current_data</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">req</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label_x</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Create data frame for label positions</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">label_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">data.frame</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label_x</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label_y</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">label</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">selected</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">nrow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">df</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.null</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">selected_label</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">selected_label</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Create the plot</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">ggplot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">df</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">aes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Add connection lines from points to labels</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">geom_segment</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data.frame</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">xend</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label_x</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">yend</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label_y</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">aes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xend</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xend</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">yend</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">yend</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">linetype</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;dashed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;black&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Add data points</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">geom_point</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Add labels (showing final result)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">geom_label</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">label_df</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">aes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">label</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">label</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fill</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">selected</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">scale_fill_manual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">values</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;FALSE&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;white&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;TRUE&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;#dbeafe&#34;</span><span style="color:#000;font-weight:bold">),</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">guide</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;none&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># Styling</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">coord_cartesian</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">xlim</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x_min</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x_max</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ylim</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">y_min</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">y_max</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">clip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;off&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">p</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Generate R code</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">output</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">r_code</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">renderText</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">current_data</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">req</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label_x</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">labels</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;&#34;&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;&#34;&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;, &#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">x_coords</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;    &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%.2f&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label_x</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;,\n&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">y_coords</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;    &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%.2f&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rv</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">label_y</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;,\n&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">library(ggplot2)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">library(ggrepel)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"># Your data
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">df &lt;- data.frame(
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  x = c(%s),
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  y = c(%s),
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  label = c(%s)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"># Custom label positions from dragging
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">label_positions &lt;- data.frame(
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  x = c(
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">%s),
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  y = c(
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">%s))
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"># Create the plot
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ggplot(df, aes(x = x, y = y)) +
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  geom_point() +
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  geom_label_repel(
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    aes(label = label),
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    nudge_x = label_positions$x - df$x,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    nudge_y = label_positions$y - df$y) +
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  xlim(%s, %s) +
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  ylim(%s, %s)&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%.2f&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;, &#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%.2f&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;, &#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">labels</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">x_coords</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">y_coords</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x_min</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x_max</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">y_min</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">y_max</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">shinyApp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ui</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ui</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">server</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">server</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div>
</main>

  <footer>
  <hr/>
  John L. Godlee | 
  <a href="mailto:johngodlee@gmail.com">johngodlee@gmail.com</a> |
  <a href="http://johngodlee.xyz//index.xml">RSS</a>

  </footer>
  </body>
</html>

