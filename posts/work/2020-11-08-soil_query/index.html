<!DOCTYPE html>
<html lang="en-gb">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>John L. Godlee</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">John L. Godlee</a></li>
      
      <li><a href="/files/cv/john_l_godlee_cv.pdf">CV</a></li>
      
      <li><a href="/works">Works</a></li>
      
    </ul>
    <hr/>
    </nav>


<div>
<h1>Querying the SoilGrids REST API</h1>

<h2>2020-11-08</h2>
</div>

<main>
<p>This week I have been working on the <a href="">SEOSAW database</a>
, which holds tree measurement data from around 7000 survey plots in southern Africa. The database is always difficult to deal with, mostly because the component datasets were all collected with different initial purposes, meaning there is a significant amount of data bashing to get each one into the SEOSAW format. I chose to use an R package to hold functions and workflows for cleaning the datasets and compiling the main database. In previous versions of the package I had a number of reduced size spatial data layers held as data objects in the package, which I could then query for information at each plot such as estimated herbivore biomass, elevation, and administrative region. I&rsquo;ve since removed all of these functions, because they were too temperamental and the trade-off in spatial resolution that came from storing reduced size versions of each data layer in the package was too great. Now the data layers are queried at full resolution in a separate process right at the end of dataset compilation.</p>
<p>One of the functions which I was actually quite proud of was one that queried the <a href="https://www.isric.org/" target="_blank">SoilGrids</a>
 <a href="https://rest.soilgrids.org/soilgrids/v2.0/docs" target="_blank">REST API</a>
 to get soil information. The function also provided functionality for averaging over soil depths. The SoilGrids REST API is still experimental, and since I first wrote the function they upgraded to v2.0. This broke the function and so it didn&rsquo;t work for a long time.</p>
<p>I re-wrote the function yesterday and thought I would post it here, as it probably won&rsquo;t get any use elsewhere. I also wrote a companion function which sends an empty query to get back all possible combinations of soil attributes, depths, and values (mean, Q0.05 etc.).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; Query SoilGrids via the REST API </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; See https://rest.soilgrids.org/soilgrids/v2.0/docs for more information</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; @param x dataframe of plot level data</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; @param plot_id column name string of plot IDs</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; @param longitude_of_centre column name string of plot longitude</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; @param latitude_of_centre column name string of plot latitude</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; @param attrib vector of soil attributes to extract</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; @param depth vector of soil depths over which to extract the attributes, e.g. 0-5, 30-60</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; @param average optional list of vectors, each of length 2, describing ranges </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39;     of depths over which to average (mean) the values of attrib</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; @param value vector of soil values to extract for each attribute, e.g. mean, Q0.05 </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; @details See \code{soilQueryOptions()} for all possibly combinations of </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39;     attrib, depth, and value</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; @return dataframe of soil values by depth</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; @importFrom httr GET content</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; @export</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; </span>
</span></span><span style="display:flex;"><span><span style="color:#000">soilQuery</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plot_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;plot_id&#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#000">longitude_of_centre</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;longitude_of_centre&#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#000">latitude_of_centre</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;latitude_of_centre&#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#000">attrib</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cec&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;cfvo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;clay&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;nitrogen&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ocd&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ocs&#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;phh20&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;sand&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;silt&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;soc&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">depth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;0-5&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;5-15&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;15-30&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;30-60&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;60-100&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;100-200&#34;</span><span style="color:#000;font-weight:bold">),</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#000">average</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#000;font-weight:bold">)),</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;mean&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">default_attrib</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bdod&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;cec&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;cfvo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;clay&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;nitrogen&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ocd&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ocs&#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;phh20&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;sand&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;silt&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;soc&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">default_depth</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;0-5&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;5-15&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;15-30&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;30-60&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;60-100&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;100-200&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">depth_values</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">unique</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">unlist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">strsplit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">default_depth</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;-&#34;</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">default_value</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Q0.05&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Q0.5&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Q0.95&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;mean&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;uncertainty&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Check input</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">any</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">attrib</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">default_attrib</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">stop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Illegal soil attribute: &#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">attrib[</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">attrib</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">default_attrib]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;, &#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;\n\tAllowed values: &#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">default_attrib</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;, &#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;\n\tRun `soilQueryOptions()` to find valid attributes&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">any</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">depth</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">default_depth</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">stop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Illegal depth: &#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">depth[</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">depth</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">default_depth]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;, &#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;\n\tallowed values: &#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">default_depth</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;, &#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;\n\tRun `soilQueryOptions()` to find valid depths&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.null</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">average</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">any</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">unlist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">average</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">depth_values</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">stop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Illegal averaging depth: &#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">average[</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">unlist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">average</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">depth_values]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;, &#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;\n\tallowed values: &#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">depth_values</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;, &#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">any</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">unlist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">average</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">depth_values</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">unlist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">average</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">depth_values</span><span style="color:#000;font-weight:bold">)))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">stop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;average range values outside sampled depths: &#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">unlist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">average</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[unlist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">average</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">depth_values</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">unlist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">average</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">depth_values</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>          <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;, &#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">any</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">average</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">})))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">stop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;All average ranges must be vectors of length 2&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">any</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">default_value</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">stop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Illegal value: &#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value[</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">default_value]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;, &#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;\n\tallowed values: &#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">default_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;, &#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;\n\tRun `soilQueryOptions()` to find valid values&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Construct query</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">attrib_string</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&amp;property=&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">attrib</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">depth_string</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&amp;depth=&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">depth</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;cm&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">value_string</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&amp;value=&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">collapse</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">queries</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000">nrow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">call</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">paste0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;https://rest.soilgrids.org/soilgrids/v2.0/properties/query?&#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;lon=&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x[y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">longitude_of_centre]</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;&amp;lat=&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x[y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">latitude_of_centre]</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">attrib_string</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">depth_string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">value_string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Run GET query</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">query_get</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">queries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">httr</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">GET</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># If any queries fail, end function</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">any</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">unlist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">query_get</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">`[[`</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;status_code&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">stop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Some queries failed&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Flatten to list</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">query_list</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">query_get</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">httr</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">content</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">as</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;parsed&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># For each query, for each attrib, for each depth, for each value, extract values</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">query_extract</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">query_list</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">properties</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">layers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">z</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">depths</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">values</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">w</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Make tidy dataframe of values</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">extract_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">data.frame</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">plot_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x[[plot_id]]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">each</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">attrib</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">depth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">attrib</span> <span style="color:#ce5c00;font-weight:bold">=</span>  <span style="color:#000">rep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">attrib</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">each</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">depth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)),</span> <span style="color:#000">times</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x[[plot_id]]</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">depth</span> <span style="color:#ce5c00;font-weight:bold">=</span>   <span style="color:#000">rep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">depth</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">each</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)),</span> <span style="color:#000">times</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x[[plot_id]]</span><span style="color:#000;font-weight:bold">)),</span> <span style="color:#000">times</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">attrib</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span>   <span style="color:#000">rep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">times</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x[[plot_id]]</span><span style="color:#000;font-weight:bold">)),</span> <span style="color:#000">times</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">attrib</span><span style="color:#000;font-weight:bold">)),</span> <span style="color:#000">times</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">depth</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">extract</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">unlist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">query_extract</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Optionally average each value and attrib over depths</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">is.null</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">average</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">extract_split</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">extract_df</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">extract_df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">plot_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">extract_df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">attrib</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">extract_df</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">extract_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">do.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">extract_split</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">do.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">average</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">min_depth</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">strsplit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">depth</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;-&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">`[`</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">max_depth</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">strsplit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">depth</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;-&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">`[`</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">out_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plot_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y[1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">plot_id]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">attrib</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y[1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;attrib&#34;</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">depth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">paste</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">min_depth</span><span style="color:#000">[which</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">min_depth</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">z[1]</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">max_depth</span><span style="color:#000">[which</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">max_depth</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">z[2]</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sep</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;-&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y[1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">extract</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">extract</span><span style="color:#000">[which</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">min_depth</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">z[1]</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">which</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">max_depth</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">z[2]</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">na.rm</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">row.names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">extract_df</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">extract_df</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The function to get all possible input options:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; Query SoilGrids via the REST API </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; See https://rest.soilgrids.org/soilgrids/v2.0/docs for more information</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; @return Dataframe of all soil attributes, depths and values</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; @importFrom httr GET content</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; @export</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&#39; </span>
</span></span><span style="display:flex;"><span><span style="color:#000">soilQueryOptions</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">query_get</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">httr</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">GET</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;https://rest.soilgrids.org/soilgrids/v2.0/properties/layers&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">query_list</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">httr</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">content</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">query_get</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">as</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;parsed&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">do.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">query_list</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">layers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">attrib</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">attrib_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">do.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">layer_structure</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">depth</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">range</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">unlist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">values</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">depth</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">attrib</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">attrib</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">attrib_df</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}))</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">out</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>A test of <code>soilQuery()</code> for three locations in Africa:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plot_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;A&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;D&#34;</span><span style="color:#000;font-weight:bold">),</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#000">longitude_of_centre</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">22.674</span> <span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">15.555</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">32.122</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">-1.319738</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">latitude_of_centre</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">7.140</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">-14.736</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">-6.231</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">53.065368</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">attrib</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cec&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;clay&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;nitrogen&#34;</span><span style="color:#000;font-weight:bold">)</span> 
</span></span><span style="display:flex;"><span><span style="color:#000">depth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;0-5&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;5-15&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;15-30&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;60-100&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">average</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;mean&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Q0.5&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">soilQuery</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">attrib</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">attrib</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">depth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">depth</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">average</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">average</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>plot_id</th>
          <th>attrib</th>
          <th>depth</th>
          <th>value</th>
          <th>extract</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>A</td>
          <td>cec</td>
          <td>0-30</td>
          <td>mean</td>
          <td>102.00</td>
      </tr>
      <tr>
          <td>A</td>
          <td>cec</td>
          <td>0-15</td>
          <td>mean</td>
          <td>106.00</td>
      </tr>
      <tr>
          <td>A</td>
          <td>cec</td>
          <td>60-100</td>
          <td>mean</td>
          <td>100.00</td>
      </tr>
      <tr>
          <td>B</td>
          <td>cec</td>
          <td>0-30</td>
          <td>mean</td>
          <td>83.00</td>
      </tr>
      <tr>
          <td>B</td>
          <td>cec</td>
          <td>0-15</td>
          <td>mean</td>
          <td>84.50</td>
      </tr>
      <tr>
          <td>B</td>
          <td>cec</td>
          <td>60-100</td>
          <td>mean</td>
          <td>72.00</td>
      </tr>
      <tr>
          <td>C</td>
          <td>cec</td>
          <td>0-30</td>
          <td>mean</td>
          <td>53.00</td>
      </tr>
      <tr>
          <td>C</td>
          <td>cec</td>
          <td>0-15</td>
          <td>mean</td>
          <td>56.50</td>
      </tr>
      <tr>
          <td>C</td>
          <td>cec</td>
          <td>60-100</td>
          <td>mean</td>
          <td>44.00</td>
      </tr>
      <tr>
          <td>D</td>
          <td>cec</td>
          <td>0-30</td>
          <td>mean</td>
          <td>152.33</td>
      </tr>
      <tr>
          <td>D</td>
          <td>cec</td>
          <td>0-15</td>
          <td>mean</td>
          <td>173.00</td>
      </tr>
      <tr>
          <td>D</td>
          <td>cec</td>
          <td>60-100</td>
          <td>mean</td>
          <td>94.00</td>
      </tr>
      <tr>
          <td>A</td>
          <td>clay</td>
          <td>0-30</td>
          <td>mean</td>
          <td>187.00</td>
      </tr>
      <tr>
          <td>A</td>
          <td>clay</td>
          <td>0-15</td>
          <td>mean</td>
          <td>161.50</td>
      </tr>
      <tr>
          <td>A</td>
          <td>clay</td>
          <td>60-100</td>
          <td>mean</td>
          <td>335.00</td>
      </tr>
      <tr>
          <td>B</td>
          <td>clay</td>
          <td>0-30</td>
          <td>mean</td>
          <td>85.67</td>
      </tr>
      <tr>
          <td>B</td>
          <td>clay</td>
          <td>0-15</td>
          <td>mean</td>
          <td>73.50</td>
      </tr>
      <tr>
          <td>B</td>
          <td>clay</td>
          <td>60-100</td>
          <td>mean</td>
          <td>321.00</td>
      </tr>
      <tr>
          <td>C</td>
          <td>clay</td>
          <td>0-30</td>
          <td>mean</td>
          <td>108.00</td>
      </tr>
      <tr>
          <td>C</td>
          <td>clay</td>
          <td>0-15</td>
          <td>mean</td>
          <td>110.50</td>
      </tr>
      <tr>
          <td>C</td>
          <td>clay</td>
          <td>60-100</td>
          <td>mean</td>
          <td>265.00</td>
      </tr>
      <tr>
          <td>D</td>
          <td>clay</td>
          <td>0-30</td>
          <td>mean</td>
          <td>195.33</td>
      </tr>
      <tr>
          <td>D</td>
          <td>clay</td>
          <td>0-15</td>
          <td>mean</td>
          <td>211.00</td>
      </tr>
      <tr>
          <td>D</td>
          <td>clay</td>
          <td>60-100</td>
          <td>mean</td>
          <td>111.00</td>
      </tr>
      <tr>
          <td>A</td>
          <td>nitrogen</td>
          <td>0-30</td>
          <td>mean</td>
          <td>97.00</td>
      </tr>
      <tr>
          <td>A</td>
          <td>nitrogen</td>
          <td>0-15</td>
          <td>mean</td>
          <td>110.50</td>
      </tr>
      <tr>
          <td>A</td>
          <td>nitrogen</td>
          <td>60-100</td>
          <td>mean</td>
          <td>45.00</td>
      </tr>
      <tr>
          <td>B</td>
          <td>nitrogen</td>
          <td>0-30</td>
          <td>mean</td>
          <td>48.00</td>
      </tr>
      <tr>
          <td>.</td>
          <td>&hellip;</td>
          <td>&hellip;</td>
          <td>&hellip;</td>
          <td>&hellip;</td>
      </tr>
  </tbody>
</table>

</main>

  <footer>
  <hr/>
  John L. Godlee | 
  <a href="mailto:johngodlee@gmail.com">johngodlee@gmail.com</a> |
  <a href="http://johngodlee.xyz//index.xml">RSS</a>

  </footer>
  </body>
</html>

