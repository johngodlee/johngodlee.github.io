<!DOCTYPE html>
<html lang="en-gb">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>John L. Godlee</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">John L. Godlee</a></li>
      
      <li><a href="/files/cv/john_l_godlee_cv.pdf">CV</a></li>
      
      <li><a href="/works">Works</a></li>
      
    </ul>
    <hr/>
    </nav>


<div>
<h1>Comparing coordinates of tree stems collected with GPS or tape measures</h1>

<h2>2022-08-27</h2>
</div>

<main>
<p>In 2018 and 2019 I set up some 100x100 m (1 ha) permanent vegetation monitoring plots in Bicuar National Park, southwest Angola. We measured the stem diameter of each tree stem &gt;5 cm diameter and attached a numbered metal tag to each of these stems so we could track the growth and mortality of each stem over time. At the same time as measuring the stem diameters and attaching the tags, I also took a quick GPS point with a Garmin GPSMAP 65s Handheld GPS unit.</p>
<p>There are two principle reasons to record the location of each stem in the plot. The first is to make it easier to relocate stems in the future. Sometimes tags fall off or stems are completely vaporised by fire. If we know the location of the stem, we can visit that location and confirm what has happened to the stem since the last survey. The second reason is that if we understand the spatial distribution of stems, we can better understand competitive (or facilitative) interactions among individuals, and look at how these interactions affect growth rates.</p>
<p>When I revisited the plots in 2022, my goal was to collect lots of auxiliary data, to enrich our picture of the ecosystem. Alongside collecting data on woody debris, herbaceous biomass, and tree leaf traits, I also decided to record the position of tree stems that had recruited since the initial survey back in 2018/2019. Instead of using a GPS, this time I used tape measures to record the position of each stem, using an XY coordinate system.</p>
<figure><a href="/img_full/gps_xy/diag.png"><img
          alt="Diagram showing the XY grid coordinate system in a 1 ha plot."
          title="Diagram showing the XY grid coordinate system in a 1 ha plot."src="/img/gps_xy/diag.png" 
      /></a></figure>


<p>While we had the tape measures set up, I also re-recorded the positions of existing stems so I could compare the two methods of measuring the stem location. Setting the tape measures takes a long time, while a GPS point is very quick. If the accuracy of the GPS points is good enough, there&rsquo;s no need to waste time with the tape measures.</p>
<p>To make the latitude-longitude coordinates comparable with the XY coordinates, I converted the lat-long coordinates to XY coordinates using a function I wrote in R. Hopefully the comments on the code suffice to describe whats going on, but the basic idea is that the function takes a dataframe of stem measurements in multiple plots and an <code>{sf}</code> polygons object with multiple plot polygons, linked by the <code>plot_id</code> column. For each plot, the function follows this process:</p>
<ol>
<li>Find the southwest and southeast corners of the polygon</li>
<li>Rotate both the polygon and the stem locations so that the SW-SE axis of the polygon runs exactly E-W.</li>
<li>Calculate the E-W and N-S distance from the southwest corner of the plot to each stem location, in metres.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#8f5902;font-style:italic">#&#39; Convert lat-long stem coordinates to XY grid coordinates </span>
<span style="color:#8f5902;font-style:italic">#&#39;</span>
<span style="color:#8f5902;font-style:italic">#&#39; In rectangular plots to convert latitude and longitude coordinates to XY </span>
<span style="color:#8f5902;font-style:italic">#&#39; grid coordinates, using the southwest corner of the plot as the origin point </span>
<span style="color:#8f5902;font-style:italic">#&#39; (0,0), with the X axis increasing west -&gt; east.</span>
<span style="color:#8f5902;font-style:italic">#&#39;</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param x dataframe of stem data</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param polys sf object containing plot polygons, assumes all are rectangular</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param stem_plot_id column name string of plot IDs in x</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param polys_plot_id column name string of plot IDs in polys</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param longitude column name string of stem longitude in x</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param latitude column name string of stem latitude in x</span>
<span style="color:#8f5902;font-style:italic">#&#39; @param x_crs coordinate reference system (CRS) or EPSG code of stem </span>
<span style="color:#8f5902;font-style:italic">#&#39;     coordinates. </span>
<span style="color:#8f5902;font-style:italic">#&#39;</span>
<span style="color:#8f5902;font-style:italic">#&#39; @return dataframe of measurement IDs with x_grid and y_grid filled </span>
<span style="color:#8f5902;font-style:italic">#&#39;     with estimated XY grid coordinates. NA values returned if </span>
<span style="color:#8f5902;font-style:italic">#&#39;     longitude and latitude were missing. </span>
<span style="color:#8f5902;font-style:italic">#&#39; </span>
<span style="color:#8f5902;font-style:italic">#&#39; @examples</span>
<span style="color:#8f5902;font-style:italic">#&#39; </span>
<span style="color:#8f5902;font-style:italic">#&#39; </span>
<span style="color:#8f5902;font-style:italic">#&#39; @export</span>
<span style="color:#8f5902;font-style:italic">#&#39; </span>
<span style="color:#000">gridCoordGen</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">polys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stem_plot_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;plot_id&#34;</span><span style="color:#000;font-weight:bold">,</span> 
  <span style="color:#000">polys_plot_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">stem_plot_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">measurement_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;measurement_id&#34;</span><span style="color:#000;font-weight:bold">,</span>  
  <span style="color:#000">longitude</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;longitude&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">latitude</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;latitude&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">x_crs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4326</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>

  <span style="color:#8f5902;font-style:italic"># Split stems by plot_id</span>
  <span style="color:#000">x_split</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x[[stem_plot_id]]</span><span style="color:#000;font-weight:bold">)</span>

  <span style="color:#8f5902;font-style:italic"># For each plot</span>
  <span style="color:#000">grid_all</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">do.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lapply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">seq_along</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic"># Get plot ID</span>
    <span style="color:#000">plot_id</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">unique</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_split[[y]][[stem_plot_id]]</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Subset polys to plot ID</span>
    <span style="color:#000">poly_fil</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">polys[polys[[polys_plot_id]]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">plot_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span>

    <span style="color:#8f5902;font-style:italic"># Convert corners to points</span>
    <span style="color:#000">poly_points</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_coordinates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poly_fil</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Get UTM zone of corners</span>
    <span style="color:#000">utm_string</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">UTMProj4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">latLong2UTM</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poly_points[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poly_points[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)))</span>

    <span style="color:#8f5902;font-style:italic"># Convert polygons to UTM</span>
    <span style="color:#000">poly_utm</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_transform</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poly_fil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">utm_string</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Convert UTM polygons to points</span>
    <span style="color:#000">points_utm</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_cast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poly_utm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;POINT&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">warn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">]</span>

    <span style="color:#8f5902;font-style:italic"># Extract coordinates as dataframe</span>
    <span style="color:#000">coords_utm</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_coordinates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">[1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Define points to match corners to</span>
    <span style="color:#000">match_point</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_sfc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_point</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords_utm</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">X</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords_utm</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">Y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)))</span>
    <span style="color:#000">other_point</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_sfc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_point</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords_utm</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">X</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coords_utm</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">Y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)))</span>

    <span style="color:#8f5902;font-style:italic"># Set CRS</span>
    <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">other_point</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">utm_string</span>
    <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">match_point</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">utm_string</span>

    <span style="color:#8f5902;font-style:italic"># Get sw and se corner</span>
    <span style="color:#000">sw_corner</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">points_utm[sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_nearest_feature</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">match_point</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">),</span><span style="color:#000">]</span>
    <span style="color:#000">se_corner</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">points_utm[sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_nearest_feature</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">other_point</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">),</span><span style="color:#000">]</span>

    <span style="color:#8f5902;font-style:italic"># Convert to WGS for geosphere compatibility</span>
    <span style="color:#000">sw_wgs</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_coordinates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_transform</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sw_corner</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4326</span><span style="color:#000;font-weight:bold">))</span>
    <span style="color:#000">se_wgs</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_coordinates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_transform</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">se_corner</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4326</span><span style="color:#000;font-weight:bold">))</span>

    <span style="color:#8f5902;font-style:italic"># Find rotation along SW,SE edge</span>
    <span style="color:#000">xy_bearing</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">geosphere</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">bearing</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sw_wgs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">se_wgs</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Get centroid of polygon</span>
    <span style="color:#000">cent</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_centroid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_geometry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">poly_utm</span><span style="color:#000;font-weight:bold">))</span>

    <span style="color:#8f5902;font-style:italic"># Get location of sw corner</span>
    <span style="color:#000">sw_cent</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_geometry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sw_corner</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Convert angle to radians for rotation</span>
    <span style="color:#000">angle</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">NISTunits</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">NISTdegTOradian</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">90</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">xy_bearing</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Convert stem coords to sf object</span>
    <span style="color:#000">x_sf</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">st_as_sf</span><span style="color:#000;font-weight:bold">(</span>
      <span style="color:#000">x_split[[y]][</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">measurement_id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">longitude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">latitude</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">,</span> 
      <span style="color:#000">coords</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">longitude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">latitude</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">na.fail</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_sf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x_crs</span>

    <span style="color:#8f5902;font-style:italic"># Transform stems sf to UTM</span>
    <span style="color:#000">x_utm</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">st_transform</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_sf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">utm_string</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Rotate the stems same as polygon</span>
    <span style="color:#000">x_rot</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">st_geometry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_utm</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">cent</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">rot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">angle</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">cent</span>
    <span style="color:#000">sw_cent_rot</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sw_cent</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">cent</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">rot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">angle</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">cent</span>
    <span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sw_cent_rot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_rot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">st_crs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">points_utm</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#000">x_cent</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x_rot</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">sw_cent_rot</span>
    
    <span style="color:#000">x_cent_df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">as.data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">st_coordinates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_cent</span><span style="color:#000;font-weight:bold">))</span>
    <span style="color:#000">names</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_cent_df</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;x_grid&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;y_grid&#34;</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Add cordinates to dataframe</span>
    <span style="color:#000">x_out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">cbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">st_drop_geometry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_sf</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">x_cent_df</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic"># Sub in empty stems</span>
    <span style="color:#000">if </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">any</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">x_split[[y]][[measurement_id]]</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">x_out[[measurement_id]]</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">missed_stems</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">x_split[[y]][</span>
        <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">x_split[[y]][[measurement_id]]</span> <span style="color:#ce5c00;font-weight:bold">%in%</span> <span style="color:#000">x_out[[measurement_id]]</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">measurement_id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span>

      <span style="color:#000">x_out</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">rbind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">missed_stems</span><span style="color:#000;font-weight:bold">)</span>

      <span style="color:#8f5902;font-style:italic"># NaN to NA</span>
      <span style="color:#000">x_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x_grid</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">fillNA</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">x_grid</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000">x_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">y_grid</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">fillNA</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_out</span><span style="color:#ce5c00;font-weight:bold">$</span><span style="color:#000">y_grid</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic"># Return</span>
    <span style="color:#000">x_out</span>
  <span style="color:#000;font-weight:bold">}))</span>

  <span style="color:#8f5902;font-style:italic"># Return</span>
  <span style="color:#000">return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">grid_all</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>I then matched the measurements using the tag ID of each stem, and calculated the distance between them.</p>
<p>The main problem with this comparison between GPS and tape measure is that neither of these methods are guaranteed to provide the truth. There is random error in the GPS points, handheld GPS units are only accurate to about 2-3 m. However, there are also errors in the tape measure method. Firstly, the edges of the plot might not be totally square. The XY coordinate system relies on the corners of the plot having a perfect 90 degree angle, and each edge being a perfectly straight line, but in the field this is difficult to achieve. Sometimes the plots come out slightly rhombic, despite our best efforts. It&rsquo;s also common for the tape measures to bow slightly in or out of the plot. If the edge bows in, the distance from the plot edge to a stem will be less in the middle of the plot than at the edges of the plot. This is a particularly problem in a grassy plot on a windy day, as the grass moves the tape measure. The only way to stop this is to place the tape measure very close to the ground and to anchor the tape measure at regular intervals. Secondly, the tape measures may stretch slightly leading to an under-estimate of the measurement. Thirdly, the tape measures may not be laid out perfectly parallel to the plot edges. A tape measure laid out at an angle will increase the measured length. Finally, there may be reporting errors in the field, and there may be transcription errors when typing the data up onto the computer. Commonly decimal points are put in the wrong place, or 65.6 m gets called out as 45.6 m, when we move to a new row.</p>
<figure><a href="/img_full/gps_xy/pretty_plot.png"><img
          alt="Map of all location errors."
          title="Map of all location errors."src="/img/gps_xy/pretty_plot.png" 
      /></a></figure>


<p>One really interesting thing about the plot above is that it looks like the errors get larger in the top part of the plot, and also that the errors on the X axis are larger than the errors on the Y axis.</p>
<p>In the field we always started collecting the XY coordinates from the SW corner of the plot, doing 20 m lines of trees running E-W up to the NE corner. I wonder if the errors are larger at the top of the plot because we were getting tired towards the end of the day.</p>
<p>I plotted the errors by angle using a rose diagram which sums the total error distance within each 10 degree angle bin. It looks like the biggest and most frequent errors are where the grid coordinate is east than the GPS coordinate. This systematic error probably has something to do with how we set up the tapes in the plots, and represents error in the grid coordinates rather than the GPS coordinates, as I&rsquo;d expect the GPS coordinate error to be random noise. It suggests that the person measuring the X axis coordinate consistently over-estimated the position on the tape measure.</p>
<p>The mean distance between GPS and grid coordinates was TODO m +/-,</p>

</main>

  <footer>
  <hr/>
  John L. Godlee | 
  <a href="mailto:johngodlee@gmail.com">johngodlee@gmail.com</a> |
  <a href="http://johngodlee.xyz//index.xml">RSS</a>

  </footer>
  </body>
</html>

